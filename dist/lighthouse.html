<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Lighthouse Keeper</title>
  <meta name="description" content="A narrative game about memory, power, and the violence of record-keeping.">
  <meta name="author" content="The Lighthouse Keeper">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <style>
/* === src/css/themes.css === */
/* THE LIGHTHOUSE KEEPER - Theme & Typography System */

/* ===== CSS CUSTOM PROPERTIES ===== */
:root {
  /* The Sea (Interface Background) */
  --sea-deep: #0a1419;
  --sea-mid: #12202a;
  --sea-surface: #1a2d3a;
  --sea-foam: #243d4d;

  /* The Land (Text, Villagers) */
  --land-dark: #1a1612;
  --land-wood: #2a2622;
  --land-sand: #d4c4a8;
  --land-light: #e8dcc8;

  /* The Light (Accents, Interaction) */
  --light-glow: #f0c860;
  --light-dim: #a08030;
  --light-danger: #c04030;
  --light-verdant: #40a060;
  --light-warning: #c09030;

  /* Family Colors */
  --family-shore: #2d5a3d;
  --family-church: #8a7a50;
  --family-newcomer: #5a6a7a;
  --family-hill: #7a6a50;

  /* Typography */
  --font-display: 'Libre Baskerville', Georgia, serif;
  --font-body: 'Libre Baskerville', Georgia, serif;
  --font-system: 'IBM Plex Mono', 'Courier New', monospace;
  --font-log: 'Libre Baskerville', Georgia, serif;

  /* Spacing */
  --space-xs: 0.25rem;
  --space-sm: 0.5rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;
  --space-2xl: 3rem;

  /* Border Radius */
  --radius-sm: 2px;
  --radius-md: 4px;
  --radius-lg: 8px;

  /* Transitions */
  --transition-fast: 150ms ease;
  --transition-normal: 300ms ease;
  --transition-slow: 500ms ease;

  /* Z-Index Scale */
  --z-base: 0;
  --z-beam: 1;
  --z-content: 10;
  --z-overlay: 50;
  --z-modal: 100;
  --z-vignette: 200;
}

/* ===== TYPOGRAPHY ===== */

/* Headers - Libre Baskerville */
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-display);
  font-weight: 400;
  color: var(--land-light);
  line-height: 1.3;
  margin: 0 0 var(--space-md) 0;
}

h1 {
  font-size: 2rem;
  letter-spacing: 0.05em;
}

h2 {
  font-size: 1.5rem;
  letter-spacing: 0.03em;
}

h3 {
  font-size: 1.25rem;
}

h4 {
  font-size: 1rem;
  font-weight: 700;
}

/* Body Text */
body {
  font-family: var(--font-body);
  font-size: 16px;
  line-height: 1.7;
  color: var(--land-sand);
}

p {
  margin: 0 0 var(--space-md) 0;
}

/* Italic for testimonial/narrative */
.testimonial,
.narrative,
blockquote {
  font-style: italic;
  color: var(--land-light);
}

blockquote {
  margin: var(--space-lg) 0;
  padding: var(--space-md) var(--space-lg);
  border-left: 2px solid var(--light-dim);
  background: rgba(26, 45, 58, 0.3);
}

/* System/Interface Text - IBM Plex Mono */
.system-text,
.interface-label,
.stat-value,
.time-display {
  font-family: var(--font-system);
  font-size: 0.875rem;
  letter-spacing: 0.02em;
}

/* Log Entry Text */
.log-entry,
.entry-preview {
  font-family: var(--font-log);
  font-size: 1rem;
  line-height: 1.8;
  color: var(--land-dark);
}

/* Small/Caption Text */
.caption,
.hint,
small {
  font-size: 0.8125rem;
  color: var(--sea-foam);
}

/* ===== WELLBEING/TRUST COLORS ===== */

.wellbeing-high { color: var(--light-verdant); }
.wellbeing-medium { color: var(--light-warning); }
.wellbeing-low { color: var(--light-danger); }

.trust-high { color: var(--light-glow); }
.trust-medium { color: var(--light-dim); }
.trust-low { color: var(--light-danger); }

/* ===== FAMILY COLORS ===== */

.family-shore { border-color: var(--family-shore); }
.family-shore .family-indicator { background: var(--family-shore); }

.family-church { border-color: var(--family-church); }
.family-church .family-indicator { background: var(--family-church); }

.family-newcomer { border-color: var(--family-newcomer); }
.family-newcomer .family-indicator { background: var(--family-newcomer); }

.family-hill { border-color: var(--family-hill); }
.family-hill .family-indicator { background: var(--family-hill); }

/* ===== TENSION STATES ===== */

[data-tension="low"] {
  --tension-color: var(--sea-foam);
}

[data-tension="medium"] {
  --tension-color: var(--light-warning);
}

[data-tension="high"] {
  --tension-color: var(--light-danger);
}

[data-tension="critical"] {
  --tension-color: #ff3020;
}

/* ===== PHASE INDICATORS ===== */

[data-phase="dawn"] {
  --phase-color: #c09070;
}

[data-phase="day"] {
  --phase-color: var(--light-glow);
}

[data-phase="dusk"] {
  --phase-color: #8060a0;
}

[data-phase="night"] {
  --phase-color: #4050a0;
}

/* ===== ACCESSIBILITY ===== */

/* High Contrast Mode */
@media (prefers-contrast: high) {
  :root {
    --land-sand: #ffffff;
    --land-light: #ffffff;
    --sea-deep: #000000;
    --sea-mid: #111111;
  }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

.reduced-motion *,
.reduced-motion *::before,
.reduced-motion *::after {
  animation-duration: 0.01ms !important;
  animation-iteration-count: 1 !important;
  transition-duration: 0.01ms !important;
}

/* Focus Styles */
:focus {
  outline: 2px solid var(--light-glow);
  outline-offset: 2px;
}

:focus:not(:focus-visible) {
  outline: none;
}

:focus-visible {
  outline: 2px solid var(--light-glow);
  outline-offset: 2px;
}

/* Skip Link */
.skip-link {
  position: absolute;
  top: -100%;
  left: var(--space-md);
  padding: var(--space-sm) var(--space-md);
  background: var(--sea-mid);
  color: var(--land-light);
  z-index: 9999;
  text-decoration: none;
}

.skip-link:focus {
  top: var(--space-md);
}


/* === src/css/main.css === */
/* THE LIGHTHOUSE KEEPER - Main Styles */

/* ===== RESET & BASE ===== */
*, *::before, *::after {
  box-sizing: border-box;
}

html {
  height: 100%;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  background: var(--sea-deep);
  color: var(--land-sand);
  overflow-x: hidden;
}

/* ===== LAYOUT STRUCTURE ===== */

#game-container {
  display: grid;
  grid-template-rows: auto 1fr auto;
  grid-template-columns: 220px 1fr 280px;
  grid-template-areas:
    "header header header"
    "villagers main log"
    "fragments fragments fragments";
  min-height: 100vh;
  position: relative;
}

/* ===== HEADER ===== */

#header {
  grid-area: header;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md) var(--space-lg);
  background: linear-gradient(180deg, var(--sea-mid) 0%, transparent 100%);
  border-bottom: 1px solid rgba(240, 200, 96, 0.1);
  z-index: var(--z-content);
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--space-lg);
}

.lighthouse-icon {
  width: 40px;
  height: 40px;
  position: relative;
}

.lighthouse-icon::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 8px;
  height: 8px;
  background: var(--light-glow);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 20px var(--light-glow), 0 0 40px rgba(240, 200, 96, 0.5);
  animation: lamp-pulse 4s ease-in-out infinite;
}

@keyframes lamp-pulse {
  0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
}

.game-title {
  font-size: 1.125rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--land-light);
  margin: 0;
}

.header-center {
  display: flex;
  align-items: center;
  gap: var(--space-xl);
}

.week-display {
  font-family: var(--font-system);
  font-size: 0.875rem;
  color: var(--land-sand);
}

.week-number {
  color: var(--light-glow);
  font-weight: 600;
}

.phase-display {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.phase-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--phase-color, var(--light-dim));
}

.phase-label {
  font-family: var(--font-system);
  font-size: 0.875rem;
  text-transform: capitalize;
}

.time-display {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
}

.time-icon {
  opacity: 0.7;
}

.header-right {
  display: flex;
  align-items: center;
  gap: var(--space-md);
}

.tension-meter {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.tension-bar {
  width: 80px;
  height: 6px;
  background: var(--sea-surface);
  border-radius: 3px;
  overflow: hidden;
}

.tension-fill {
  height: 100%;
  background: var(--tension-color, var(--sea-foam));
  transition: width var(--transition-slow), background var(--transition-slow);
}

.tension-label {
  font-family: var(--font-system);
  font-size: 0.75rem;
  color: var(--sea-foam);
  text-transform: uppercase;
}

/* ===== VILLAGER PANEL ===== */

#villager-panel {
  grid-area: villagers;
  padding: var(--space-md);
  background: rgba(10, 20, 25, 0.5);
  border-right: 1px solid rgba(240, 200, 96, 0.05);
  overflow-y: auto;
  max-height: calc(100vh - 150px);
}

.panel-title {
  font-family: var(--font-system);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--sea-foam);
  margin-bottom: var(--space-md);
  padding-bottom: var(--space-sm);
  border-bottom: 1px solid rgba(240, 200, 96, 0.1);
}

.villager-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
}

.villager-card {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  padding: var(--space-sm);
  background: rgba(26, 45, 58, 0.3);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--family-shore);
  cursor: pointer;
  transition: background var(--transition-fast), transform var(--transition-fast);
}

.villager-card:hover {
  background: rgba(26, 45, 58, 0.5);
  transform: translateX(2px);
}

.villager-card.selected {
  background: rgba(240, 200, 96, 0.1);
  border-left-color: var(--light-glow);
}

.villager-card.involved {
  position: relative;
}

.villager-card.involved::after {
  content: '';
  position: absolute;
  top: var(--space-xs);
  right: var(--space-xs);
  width: 6px;
  height: 6px;
  background: var(--light-warning);
  border-radius: 50%;
}

.villager-card.spoken::before {
  content: '';
  position: absolute;
  bottom: var(--space-xs);
  right: var(--space-xs);
  width: 6px;
  height: 6px;
  background: var(--light-verdant);
  border-radius: 50%;
}

.villager-portrait {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--sea-surface);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  flex-shrink: 0;
}

.villager-info {
  flex: 1;
  min-width: 0;
}

.villager-name {
  font-size: 0.875rem;
  color: var(--land-light);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.villager-role {
  font-size: 0.6875rem;
  color: var(--sea-foam);
}

.villager-stats {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.stat-bar {
  width: 40px;
  height: 3px;
  background: var(--sea-surface);
  border-radius: 2px;
  overflow: hidden;
}

.stat-fill {
  height: 100%;
  transition: width var(--transition-normal);
}

.stat-fill.wellbeing {
  background: var(--light-verdant);
}

.stat-fill.trust {
  background: var(--light-glow);
}

/* ===== MAIN CONTENT AREA ===== */

#main-content {
  grid-area: main;
  padding: var(--space-lg);
  overflow-y: auto;
  max-height: calc(100vh - 150px);
}

.event-container {
  max-width: 700px;
  margin: 0 auto;
}

.event-title {
  font-size: 1.5rem;
  margin-bottom: var(--space-sm);
  color: var(--land-light);
}

.event-description {
  font-style: italic;
  line-height: 1.8;
  margin-bottom: var(--space-lg);
  padding: var(--space-md);
  background: rgba(26, 45, 58, 0.2);
  border-radius: var(--radius-md);
}

.investigation-section {
  margin-top: var(--space-xl);
}

.section-title {
  font-family: var(--font-system);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--sea-foam);
  margin-bottom: var(--space-md);
}

.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-md);
}

.action-card {
  padding: var(--space-md);
  background: rgba(26, 45, 58, 0.3);
  border: 1px solid rgba(240, 200, 96, 0.1);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.action-card:hover:not(.disabled) {
  background: rgba(26, 45, 58, 0.5);
  border-color: rgba(240, 200, 96, 0.3);
  transform: translateY(-2px);
}

.action-card.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.action-card.completed {
  border-color: var(--light-verdant);
  opacity: 0.7;
}

.action-title {
  font-size: 0.9375rem;
  color: var(--land-light);
  margin-bottom: var(--space-xs);
}

.action-cost {
  font-family: var(--font-system);
  font-size: 0.75rem;
  color: var(--light-dim);
}

.action-description {
  font-size: 0.8125rem;
  color: var(--sea-foam);
  margin-top: var(--space-sm);
}

/* Testimony Display */
.testimony-container {
  margin-top: var(--space-lg);
  padding: var(--space-lg);
  background: rgba(26, 45, 58, 0.2);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--light-dim);
}

.testimony-speaker {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  margin-bottom: var(--space-md);
}

.testimony-portrait {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--sea-surface);
}

.testimony-name {
  font-size: 1rem;
  color: var(--land-light);
}

.testimony-text {
  font-style: italic;
  font-size: 1.0625rem;
  line-height: 1.8;
  color: var(--land-light);
  margin-bottom: var(--space-md);
  padding-left: var(--space-md);
  border-left: 2px solid var(--sea-foam);
}

.testimony-observation {
  font-size: 0.875rem;
  color: var(--sea-foam);
  margin-top: var(--space-md);
}

.fragments-gained {
  margin-top: var(--space-md);
  padding-top: var(--space-md);
  border-top: 1px solid rgba(240, 200, 96, 0.1);
}

.fragments-gained-title {
  font-family: var(--font-system);
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--light-dim);
  margin-bottom: var(--space-sm);
}

.fragment-preview {
  display: inline-block;
  padding: var(--space-xs) var(--space-sm);
  background: rgba(240, 200, 96, 0.1);
  border: 1px solid rgba(240, 200, 96, 0.2);
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  color: var(--light-glow);
  margin: var(--space-xs);
}

/* ===== LOG PANEL ===== */

#log-panel {
  grid-area: log;
  padding: var(--space-md);
  background: linear-gradient(135deg, #e8dcc8 0%, #d4c4a8 100%);
  border-left: 1px solid rgba(26, 22, 18, 0.2);
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 150px);
}

.log-header {
  text-align: center;
  padding-bottom: var(--space-md);
  border-bottom: 1px solid rgba(26, 22, 18, 0.2);
  margin-bottom: var(--space-md);
}

.log-title {
  font-size: 1rem;
  color: var(--land-dark);
  margin: 0;
  letter-spacing: 0.1em;
}

.log-week {
  font-family: var(--font-system);
  font-size: 0.6875rem;
  color: rgba(26, 22, 18, 0.6);
  text-transform: uppercase;
}

.entry-slots {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
  overflow-y: auto;
}

.entry-slot {
  min-height: 50px;
  padding: var(--space-sm);
  background: rgba(26, 22, 18, 0.05);
  border: 2px dashed rgba(26, 22, 18, 0.2);
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
}

.entry-slot.drag-over {
  background: rgba(240, 200, 96, 0.2);
  border-color: var(--light-dim);
  border-style: solid;
}

.entry-slot.filled {
  border-style: solid;
  border-color: rgba(26, 22, 18, 0.3);
  background: rgba(255, 255, 255, 0.3);
}

.slot-label {
  font-family: var(--font-system);
  font-size: 0.625rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: rgba(26, 22, 18, 0.4);
  margin-bottom: var(--space-xs);
}

.slot-content {
  font-family: var(--font-log);
  font-size: 0.875rem;
  color: var(--land-dark);
  min-height: 1.5em;
}

.entry-preview-section {
  margin-top: var(--space-md);
  padding-top: var(--space-md);
  border-top: 1px solid rgba(26, 22, 18, 0.2);
}

.preview-label {
  font-family: var(--font-system);
  font-size: 0.625rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: rgba(26, 22, 18, 0.5);
  margin-bottom: var(--space-sm);
}

.entry-preview-text {
  font-family: var(--font-log);
  font-size: 0.9375rem;
  line-height: 1.7;
  color: var(--land-dark);
  font-style: italic;
  min-height: 3em;
}

.submit-section {
  margin-top: var(--space-md);
  padding-top: var(--space-md);
  border-top: 1px solid rgba(26, 22, 18, 0.2);
}

.submit-btn {
  width: 100%;
  padding: var(--space-md);
  background: var(--land-dark);
  color: var(--land-light);
  border: none;
  border-radius: var(--radius-md);
  font-family: var(--font-system);
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.submit-btn:hover:not(:disabled) {
  background: var(--land-wood);
  transform: translateY(-1px);
}

.submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ===== FRAGMENT TRAY ===== */

#fragment-tray {
  grid-area: fragments;
  padding: var(--space-md) var(--space-lg);
  background: var(--sea-mid);
  border-top: 1px solid rgba(240, 200, 96, 0.1);
  overflow-x: auto;
}

.tray-content {
  display: flex;
  gap: var(--space-sm);
  min-width: min-content;
}

.fragment {
  display: inline-flex;
  align-items: center;
  padding: var(--space-sm) var(--space-md);
  background: rgba(26, 45, 58, 0.5);
  border: 1px solid rgba(240, 200, 96, 0.2);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  color: var(--land-sand);
  cursor: grab;
  user-select: none;
  transition: all var(--transition-fast);
  white-space: nowrap;
}

.fragment:hover {
  background: rgba(26, 45, 58, 0.7);
  border-color: rgba(240, 200, 96, 0.4);
  transform: translateY(-2px);
}

.fragment.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.fragment.used {
  opacity: 0.4;
  cursor: not-allowed;
}

.fragment-type-indicator {
  width: 4px;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  border-radius: var(--radius-md) 0 0 var(--radius-md);
}

.fragment[data-type="tone"] { border-left: 3px solid #6a8a9a; }
.fragment[data-type="subject"] { border-left: 3px solid #8a7a6a; }
.fragment[data-type="action"] { border-left: 3px solid #7a9a6a; }
.fragment[data-type="object"] { border-left: 3px solid #9a7a8a; }
.fragment[data-type="context"] { border-left: 3px solid #7a6a9a; }

/* ===== RESPONSIVE ===== */

@media (max-width: 1024px) {
  #game-container {
    grid-template-columns: 180px 1fr 240px;
  }
}

@media (max-width: 768px) {
  #game-container {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr auto auto;
    grid-template-areas:
      "header"
      "main"
      "main"
      "log"
      "fragments";
  }

  #villager-panel {
    display: none; /* Show as modal on mobile */
  }

  #main-content,
  #log-panel {
    max-height: none;
  }
}


/* === src/css/animations.css === */
/* THE LIGHTHOUSE KEEPER - Animation System */

/* ===== LIGHTHOUSE BEAM ===== */

#lighthouse-beam {
  position: fixed;
  top: 0;
  left: 50%;
  width: 200vw;
  height: 200vh;
  transform-origin: 50% 0;
  pointer-events: none;
  z-index: var(--z-beam);
  background: conic-gradient(
    from 0deg at 50% 0%,
    transparent 0deg,
    rgba(240, 200, 96, 0.06) 1deg,
    rgba(240, 200, 96, 0.10) 3deg,
    rgba(240, 200, 96, 0.06) 5deg,
    transparent 8deg,
    transparent 360deg
  );
  animation: beam-sweep 12s linear infinite;
}

@keyframes beam-sweep {
  from { transform: translateX(-50%) rotate(0deg); }
  to { transform: translateX(-50%) rotate(360deg); }
}

#lighthouse-beam.dim {
  opacity: 0.4;
}

#lighthouse-beam.bright {
  opacity: 1;
  background: conic-gradient(
    from 0deg at 50% 0%,
    transparent 0deg,
    rgba(240, 200, 96, 0.12) 1deg,
    rgba(240, 200, 96, 0.18) 3deg,
    rgba(240, 200, 96, 0.12) 5deg,
    transparent 8deg,
    transparent 360deg
  );
}

#lighthouse-beam.flare {
  animation: beam-flare 0.5s ease-out;
}

@keyframes beam-flare {
  0% { opacity: 1; }
  50% { opacity: 1.5; filter: brightness(1.5); }
  100% { opacity: 1; }
}

/* ===== OCEAN LAYER ===== */

#ocean-layer {
  position: fixed;
  inset: 0;
  z-index: var(--z-base);
  background: linear-gradient(
    180deg,
    #0a1419 0%,
    #0d1820 40%,
    #12202a 70%,
    #1a2d3a 100%
  );
}

#ocean-layer::before {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px,
    rgba(20, 60, 80, 0.03) 1px,
    transparent 3px
  );
  animation: wave-drift 15s ease-in-out infinite;
}

#ocean-layer::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(
    ellipse at 50% 100%,
    rgba(30, 80, 100, 0.1) 0%,
    transparent 50%
  );
  animation: wave-glow 8s ease-in-out infinite;
}

@keyframes wave-drift {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(10px); }
}

@keyframes wave-glow {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

/* ===== TENSION VIGNETTE ===== */

#tension-vignette {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: var(--z-vignette);
  box-shadow: inset 0 0 100px transparent;
  transition: box-shadow 2s ease;
}

#tension-vignette.tension-low {
  box-shadow: inset 0 0 100px rgba(20, 40, 60, 0.2);
}

#tension-vignette.tension-medium {
  box-shadow: inset 0 0 120px rgba(60, 40, 30, 0.3);
}

#tension-vignette.tension-high {
  box-shadow: inset 0 0 150px rgba(80, 30, 20, 0.4);
}

#tension-vignette.tension-critical {
  box-shadow: inset 0 0 180px rgba(100, 20, 10, 0.5);
  animation: vignette-pulse 2s ease-in-out infinite;
}

@keyframes vignette-pulse {
  0%, 100% { box-shadow: inset 0 0 180px rgba(100, 20, 10, 0.5); }
  50% { box-shadow: inset 0 0 200px rgba(120, 20, 10, 0.6); }
}

/* ===== MEMORY OVERLAY ===== */

#memory-overlay {
  position: fixed;
  inset: 0;
  background: rgba(30, 25, 20, 0);
  pointer-events: none;
  z-index: var(--z-modal);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 1s ease;
}

#memory-overlay.active {
  background: rgba(30, 25, 20, 0.92);
  pointer-events: auto;
}

#memory-content {
  max-width: 500px;
  padding: 40px;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 1s ease 0.5s, transform 1s ease 0.5s;
  text-align: center;
}

#memory-overlay.active #memory-content {
  opacity: 1;
  transform: translateY(0);
}

#memory-trigger {
  font-style: italic;
  color: #c08060;
  margin-bottom: 24px;
  font-size: 0.9375rem;
}

#memory-text {
  color: #a09080;
  font-size: 1.0625rem;
  line-height: 2;
  font-family: var(--font-display);
}

#memory-dismiss {
  margin-top: 32px;
  padding: 12px 24px;
  background: transparent;
  border: 1px solid #605040;
  color: #a09080;
  font-family: var(--font-system);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all var(--transition-fast);
}

#memory-dismiss:hover {
  background: rgba(96, 80, 64, 0.2);
  border-color: #a09080;
}

/* ===== RAIN EFFECT ===== */

#rain-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 5;
  opacity: 0;
  transition: opacity 2s;
  overflow: hidden;
}

#rain-container.active {
  opacity: 1;
}

.raindrop {
  position: absolute;
  top: -20px;
  width: 1px;
  height: 20px;
  background: linear-gradient(
    to bottom,
    transparent,
    rgba(150, 180, 200, 0.5)
  );
  animation: rain-fall linear infinite;
}

@keyframes rain-fall {
  to {
    transform: translateY(100vh);
  }
}

/* ===== FOG EFFECT (Week 5) ===== */

#fog-overlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 4;
  opacity: 0;
  transition: opacity 3s;
  background:
    radial-gradient(ellipse at 20% 80%, rgba(200, 210, 220, 0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 60%, rgba(200, 210, 220, 0.1) 0%, transparent 40%),
    radial-gradient(ellipse at 50% 90%, rgba(200, 210, 220, 0.12) 0%, transparent 45%);
}

#fog-overlay.active {
  opacity: 1;
  animation: fog-drift 20s ease-in-out infinite;
}

@keyframes fog-drift {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(20px); }
}

/* ===== INK EFFECTS ===== */

@keyframes ink-bleed {
  0% {
    text-shadow: 0 0 0 currentColor;
    filter: blur(0);
  }
  30% {
    text-shadow:
      1px 0 0 currentColor,
      -1px 0 0 currentColor,
      0 1px 0 currentColor;
    filter: blur(0.5px);
  }
  100% {
    text-shadow: 0 0 0 currentColor;
    filter: blur(0);
  }
}

.entry-locked {
  animation: ink-bleed 0.5s ease-out;
}

@keyframes ink-splatter {
  0% {
    opacity: 0;
    transform: scale(0.5);
  }
  50% {
    opacity: 1;
    transform: scale(1.1);
  }
  100% {
    opacity: 0.8;
    transform: scale(1);
  }
}

.ink-splatter {
  animation: ink-splatter 0.3s ease-out forwards;
}

/* ===== WEEK TRANSITION ===== */

#week-transition {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  transition: opacity 1s ease;
}

#week-transition.active {
  opacity: 1;
  pointer-events: auto;
}

.transition-text {
  font-family: var(--font-display);
  font-size: 2rem;
  color: var(--land-light);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 1s ease, transform 1s ease;
}

#week-transition.active .transition-text {
  opacity: 1;
  transform: translateY(0);
  transition-delay: 0.5s;
}

.transition-subtext {
  font-family: var(--font-system);
  font-size: 0.875rem;
  color: var(--sea-foam);
  margin-top: 16px;
  opacity: 0;
  transition: opacity 1s ease;
}

#week-transition.active .transition-subtext {
  opacity: 1;
  transition-delay: 1s;
}

/* ===== ENTRY SUBMISSION ANIMATION ===== */

@keyframes entry-lock {
  0% {
    transform: scale(1);
  }
  10% {
    transform: scale(0.98);
  }
  30% {
    transform: scale(1.02);
  }
  100% {
    transform: scale(1);
  }
}

.entry-locking {
  animation: entry-lock 0.5s ease-out;
}

/* Screen dim during entry lock */
.screen-dim {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0);
  pointer-events: none;
  z-index: 99;
  transition: background 0.3s ease;
}

.screen-dim.active {
  background: rgba(0, 0, 0, 0.4);
}

/* ===== PORTRAIT ANIMATIONS ===== */

@keyframes portrait-speak {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.portrait-speaking {
  animation: portrait-speak 0.5s ease-in-out infinite;
}

@keyframes portrait-reaction {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.portrait-react {
  animation: portrait-reaction 0.3s ease-out;
}

/* ===== FRAGMENT ANIMATIONS ===== */

@keyframes fragment-appear {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fragment-new {
  animation: fragment-appear 0.3s ease-out;
}

@keyframes fragment-place {
  0% {
    transform: scale(1.1);
    opacity: 0.8;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.fragment-placed {
  animation: fragment-place 0.2s ease-out;
}

/* ===== MODAL ANIMATIONS ===== */

@keyframes modal-enter {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes modal-exit {
  from {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  to {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
}

.modal-entering {
  animation: modal-enter 0.3s ease-out forwards;
}

.modal-exiting {
  animation: modal-exit 0.2s ease-in forwards;
}

/* ===== LOADING/INTRO ANIMATIONS ===== */

@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slide-up {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fade-in 1s ease-out forwards;
}

.slide-up {
  animation: slide-up 0.8s ease-out forwards;
}

.delay-1 { animation-delay: 0.2s; }
.delay-2 { animation-delay: 0.4s; }
.delay-3 { animation-delay: 0.6s; }
.delay-4 { animation-delay: 0.8s; }
.delay-5 { animation-delay: 1.0s; }

/* ===== CONSEQUENCE ROLL-IN ===== */

@keyframes consequence-appear {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.consequence-item {
  animation: consequence-appear 0.4s ease-out forwards;
}

.consequence-item:nth-child(1) { animation-delay: 0.1s; }
.consequence-item:nth-child(2) { animation-delay: 0.2s; }
.consequence-item:nth-child(3) { animation-delay: 0.3s; }
.consequence-item:nth-child(4) { animation-delay: 0.4s; }
.consequence-item:nth-child(5) { animation-delay: 0.5s; }



  </style>
</head>
<body>
  <!-- Skip Link for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Background Layers -->
  <div id="ocean-layer" aria-hidden="true"></div>
  <div id="lighthouse-beam" aria-hidden="true"></div>
  <div id="rain-container" aria-hidden="true"></div>
  <div id="fog-overlay" aria-hidden="true"></div>
  <div id="tension-vignette" aria-hidden="true"></div>

  <!-- Start Screen -->
  <div id="start-screen" class="modal-overlay">
    <div class="start-content">
      <h1 class="start-title slide-up">The Lighthouse Keeper</h1>
      <p class="start-subtitle slide-up delay-1">A game about memory, power, and the violence of record-keeping</p>
      <div class="start-buttons slide-up delay-2">
        <button id="btn-new-game" class="start-btn primary">New Game</button>
        <button id="btn-continue" class="start-btn secondary" style="display: none;">Continue</button>
      </div>
      <p class="start-quote slide-up delay-3">
        "The record is never the event.<br>
        But when the record is all anyone has,<br>
        the record becomes the truth."
      </p>
    </div>
  </div>

  <!-- Main Game Container -->
  <div id="game-container" style="display: none;">
    <!-- Header -->
    <header id="header">
      <div class="header-left">
        <div class="lighthouse-icon" aria-label="Lighthouse lamp"></div>
        <h1 class="game-title">The Lighthouse Keeper</h1>
      </div>

      <div class="header-center">
        <div class="week-display">
          Week <span id="week-number" class="week-number">1</span> of 5
        </div>

        <div class="phase-display" data-phase="dawn">
          <span class="phase-indicator"></span>
          <span id="phase-label" class="phase-label">Dawn</span>
        </div>

        <div class="time-display">
          <span class="time-icon">&#9201;</span>
          <span id="time-remaining">4</span> hours remaining
        </div>
      </div>

      <div class="header-right">
        <div class="tension-meter">
          <span class="tension-label">Tension</span>
          <div class="tension-bar">
            <div id="tension-fill" class="tension-fill" style="width: 20%;"></div>
          </div>
        </div>
        <button id="btn-audio" class="icon-btn" aria-label="Toggle audio">
          <span id="audio-icon">&#128264;</span>
        </button>
        <button id="btn-menu" class="icon-btn" aria-label="Menu">&#9776;</button>
      </div>
    </header>

    <!-- Villager Panel -->
    <aside id="villager-panel" aria-label="Village residents">
      <h2 class="panel-title">The Village</h2>
      <div id="villager-list" class="villager-list"></div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content">
      <div class="event-container">
        <h2 id="event-title" class="event-title">The Disputed Catch</h2>
        <div id="event-description" class="event-description"></div>

        <section class="investigation-section">
          <h3 class="section-title">Investigation Options</h3>
          <div id="action-grid" class="action-grid"></div>
        </section>

        <div id="testimony-container" class="testimony-container" style="display: none;"></div>
      </div>
    </main>

    <!-- Log Panel -->
    <aside id="log-panel" aria-label="Official log">
      <div class="log-header">
        <h2 class="log-title">The Official Record</h2>
        <div id="log-week" class="log-week">Week 1 Entry</div>
      </div>

      <div class="entry-slots">
        <div class="entry-slot" data-slot="tone" data-accepts="tone">
          <div class="slot-label">Tone</div>
          <div class="slot-content" id="slot-tone"></div>
        </div>
        <div class="entry-slot" data-slot="subject" data-accepts="subject">
          <div class="slot-label">Subject</div>
          <div class="slot-content" id="slot-subject"></div>
        </div>
        <div class="entry-slot" data-slot="action" data-accepts="action">
          <div class="slot-label">Action</div>
          <div class="slot-content" id="slot-action"></div>
        </div>
        <div class="entry-slot" data-slot="object" data-accepts="object">
          <div class="slot-label">Object</div>
          <div class="slot-content" id="slot-object"></div>
        </div>
        <div class="entry-slot" data-slot="context" data-accepts="context">
          <div class="slot-label">Context</div>
          <div class="slot-content" id="slot-context"></div>
        </div>
      </div>

      <div class="entry-preview-section">
        <div class="preview-label">Preview</div>
        <p id="entry-preview" class="entry-preview-text">
          <em>Compose your entry by dragging fragments into the slots above...</em>
        </p>
      </div>

      <div class="submit-section">
        <button id="btn-submit-entry" class="submit-btn" disabled>
          Sign & Record Entry
        </button>
      </div>
    </aside>

    <!-- Fragment Tray -->
    <div id="fragment-tray" aria-label="Available fragments">
      <div id="fragment-list" class="tray-content"></div>
    </div>
  </div>

  <!-- Memory Overlay -->
  <div id="memory-overlay" aria-hidden="true">
    <div id="memory-content">
      <p id="memory-trigger"></p>
      <p id="memory-text"></p>
      <button id="memory-dismiss">Continue</button>
    </div>
  </div>

  <!-- Week Transition -->
  <div id="week-transition" aria-hidden="true">
    <div class="transition-text" id="transition-week"></div>
    <div class="transition-subtext" id="transition-subtext"></div>
  </div>

  <!-- Consequence Modal -->
  <div id="consequence-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content consequence-content">
      <h3 class="modal-title">The Record is Made</h3>
      <div id="consequence-entry" class="consequence-entry"></div>
      <div id="consequence-effects" class="consequence-effects"></div>
      <button id="consequence-continue" class="modal-btn">Continue</button>
    </div>
  </div>

  <!-- Screen Dim for Effects -->
  <div class="screen-dim" id="screen-dim"></div>

  <script>
// === src/js/data/villagers.js ===
// Villager Data for The Lighthouse Keeper

const Villagers = {
  marta: {
    id: 'marta',
    name: 'Old Marta',
    age: 68,
    family: 'shore',
    role: 'Elder, Widow',
    color: '#2d5a3d',

    description: {
      visible: 'The matriarch. Remembers everything. Knows where every body is buried. Commands respect through sheer presence.',
      hidden: 'Her husband was murdered twenty years ago. She knows who did it. She has chosen silence over justice.',
      secret: "Peter's father was one of the killers. Peter doesn't know. Marta has protected him from this knowledge his entire life."
    },

    wants: 'Peace. Not truth. Peace. To die knowing the village will continue.',
    fears: 'That you will write the truth. That the truth will consume everything.',

    speechPattern: 'Formal. Measured. Every sentence weighted.',

    dialogueBase: {
      greeting: "Keeper. I wondered when you'd come.",
      neutral: "The village has its ways. They've served us for generations.",
      trusting: "There are things I could tell you. Things I've never told anyone.",
      suspicious: "Be careful what you write. Words have weight here."
    }
  },

  peter: {
    id: 'peter',
    name: 'Peter',
    age: 34,
    family: 'shore',
    role: 'Fisherman',
    color: '#3a6b4a',

    description: {
      visible: "Hard worker. Quick temper. Drinks too much when things go wrong. Loves his wife Anna with a clumsy devotion. Owns his grandfather's boat.",
      hidden: "He found something in his father's effects after he died. A letter. He's starting to understand it now.",
      secret: "The letter was from Marta. It was a threat. Or a warning. Something happened between his father and Marta's husband."
    },

    wants: 'To be seen as a good man. To deserve the legacy he inherited.',
    fears: "That his father was not a good man. That he's inherited more than the boat.",

    speechPattern: 'Blunt. Emotional. Says things he regrets. Apologizes badly.',

    dialogueBase: {
      greeting: "What do you want?",
      neutral: "I work hard. I provide. That should count for something.",
      trusting: "You're alright, Keeper. Not like most outsiders.",
      suspicious: "Everyone's got opinions about my family. What's yours?"
    }
  },

  anna: {
    id: 'anna',
    name: 'Anna',
    age: 29,
    family: 'shore',
    role: 'Midwife',
    color: '#4a7a5a',

    description: {
      visible: "The one everyone trusts with their bodies, their births, their deaths. Quiet strength. Sees everything, says little.",
      hidden: "She cannot have children. It's destroying her slowly. She delivers other women's babies and goes home to cry.",
      secret: "She knows something about you. From before you came here. She met someone who knew you at a midwife's conference."
    },

    wants: "A child. Failing that, purpose. Failing that, to understand why she stays.",
    fears: "That Peter will leave her for someone who can give him sons. That she's not enough.",

    speechPattern: 'Soft but precise. Medical when uncomfortable. Warm when she trusts.',

    dialogueBase: {
      greeting: "Keeper. How can I help?",
      neutral: "I see the village at its most vulnerable. Birth and death look similar, sometimes.",
      trusting: "We're not so different, you and I. Both watching. Both carrying things.",
      suspicious: "You're careful with your words. I understand why."
    }
  },

  tomas: {
    id: 'tomas',
    name: 'Tomas',
    age: 41,
    family: 'newcomer',
    role: 'Boat Builder',
    color: '#5a6a7a',

    description: {
      visible: "Arrived five years ago, same season as you. Skilled craftsman. Keeps to himself. His boats are better than the local ones.",
      hidden: "He left the mainland because he killed someone. Accident or self-defense or murder. The law ruled it justified. His conscience didn't.",
      secret: "He recognized you when you arrived. Not your face. Your look. The look of someone running."
    },

    wants: "Absolution. For his daughter to have a life he couldn't have. To stop running.",
    fears: "That the mainland will reach him here. That his daughter will learn who he was.",

    speechPattern: 'Sparse. Careful. Listens more than speaks. When he does speak, it matters.',

    dialogueBase: {
      greeting: "Keeper.",
      neutral: "I build boats. They're good boats. That should be enough.",
      trusting: "You understand, don't you? What it's like to start over.",
      suspicious: "We both came here for reasons. I don't ask about yours."
    }
  },

  lucia: {
    id: 'lucia',
    name: 'Lucia',
    age: 22,
    family: 'newcomer',
    role: "Tomas's Daughter",
    color: '#6a7a8a',

    description: {
      visible: "Caught between worlds. Too mainland for the village, too village for the mainland. Works hard to be invisible.",
      hidden: "She's in love with Jakub. They've been meeting in secret for six months.",
      secret: "She knows her father killed someone. She found out three years ago. She's never told him she knows."
    },

    wants: "A life here. A real one. Not as an outsider's daughter, but as herself.",
    fears: "That she'll always be defined by where she came from. That love isn't enough to make a home.",

    speechPattern: 'Shifts. Mainland polish when nervous. Village rhythm when comfortable.',

    dialogueBase: {
      greeting: "Oh! Keeper. I didn't see you there.",
      neutral: "I try to be helpful. To fit in. It's harder than it looks.",
      trusting: "You see me, don't you? Not just my father's daughter.",
      suspicious: "People talk about my family. I know they do."
    }
  },

  simao: {
    id: 'simao',
    name: 'Father Simao',
    age: 55,
    family: 'church',
    role: 'Priest',
    color: '#8a7a50',

    description: {
      visible: "Sent here as quiet punishment for something never discussed. Has grown to love the village. Drinks with the fishermen.",
      hidden: "He heard the confession of the man who killed Marta's husband. He knows everything. He can never tell.",
      secret: "He's in love with Anna. Has been for years. Has never said a word. Never will."
    },

    wants: "To believe again. Or to stop pretending he believes. Either would be relief.",
    fears: "Dying with all these secrets. Being forgotten as the drunk priest of a dying village.",

    speechPattern: 'Liturgical rhythms even in casual speech. Quotes scripture without meaning to.',

    dialogueBase: {
      greeting: "Ah, the Keeper. Come, sit. The wine is poor but the company is honest.",
      neutral: "Faith is a strange thing. It grows stronger in thin soil, sometimes.",
      trusting: "I've heard confessions for thirty years. Yours would not be the heaviest.",
      suspicious: "The record and the confession. Both sacred. Both dangerous."
    }
  },

  bela: {
    id: 'bela',
    name: 'Bela',
    age: 16,
    family: 'shore',
    role: "Marta's Grandson, Goatherd",
    color: '#4a5a3a',

    description: {
      visible: "Strange boy. Watches everything. Says little. The goats follow him like he's one of them.",
      hidden: "He knows everything. He's been watching the adults lie to each other his entire life.",
      secret: "He saw what happened the night of the storm. He knows who cut the rope."
    },

    wants: "For someone to ask him what he knows. To matter. To be seen.",
    fears: "That he'll become like them. Keeping secrets. Telling lies. Forgetting how to be honest.",

    speechPattern: 'Almost monosyllabic. But when he speaks, listen. He never speaks without purpose.',

    dialogueBase: {
      greeting: "...",
      neutral: "I watch.",
      trusting: "You write things down. I remember things. We're similar.",
      suspicious: "I see what you write. I see what you don't."
    }
  },

  jakub: {
    id: 'jakub',
    name: 'Jakub',
    age: 24,
    family: 'shore',
    role: "Peter's Younger Brother",
    color: '#3a5a4a',

    description: {
      visible: "Quieter than Peter. In his shadow. In love with Lucia.",
      hidden: "Will fight for her if he has to.",
      secret: "Doesn't know yet what that might cost."
    },

    wants: "To be his own man. To love who he loves without permission.",
    fears: "That he'll always be Peter's little brother. That the village won't let him choose.",

    speechPattern: 'Thoughtful. Careful. Speaks only when he has something worth saying.',

    dialogueBase: {
      greeting: "Keeper. Good day.",
      neutral: "My brother speaks for the family. I just work.",
      trusting: "Some things are worth more than tradition.",
      suspicious: "I know people talk. Let them."
    }
  },

  helena: {
    id: 'helena',
    name: 'Helena',
    age: 45,
    family: 'hill',
    role: 'Tavern Keeper',
    color: '#7a6a50',

    description: {
      visible: "Hears everything said over drink. Knows which marriages are failing, which debts are unpaid.",
      hidden: "A potential source. Or a threat.",
      secret: "She trades in information. Everyone's business is her currency."
    },

    wants: "Security. Influence. To never be powerless again.",
    fears: "Being irrelevant. Being forgotten.",

    speechPattern: 'Warm on the surface. Calculating underneath.',

    dialogueBase: {
      greeting: "Keeper! What'll it be tonight?",
      neutral: "People talk when they drink. It's natural. Healthy, even.",
      trusting: "I hear things, you know. Things that might be useful to a man in your position.",
      suspicious: "Careful what you ask. Some questions have prices."
    }
  },

  oldSimao: {
    id: 'oldSimao',
    name: 'Old Simao',
    age: 77,
    family: 'shore',
    role: 'Retired Fisherman, Storyteller',
    color: '#5a5a4a',

    description: {
      visible: "Knew Marta's husband. Knew Peter's father. Remembers the wreck.",
      hidden: "Starting to lose his memory. Or pretending to.",
      secret: "Tells stories that might be truth or might be myth. Perhaps he no longer knows the difference."
    },

    wants: "To be heard. To matter before he's gone.",
    fears: "Being forgotten. His stories dying with him.",

    speechPattern: 'Wandering. Repetitive. Occasionally startlingly clear.',

    dialogueBase: {
      greeting: "Ah! Sit, sit. Let me tell you about the old days.",
      neutral: "The sea takes and gives. That's always been true. Always will be.",
      trusting: "There are things I remember. Things others have forgotten. Or want to forget.",
      suspicious: "Memory's a strange thing. Some things stay clear. Others... drift."
    }
  }
};

// Family groupings
const Families = {
  shore: {
    name: 'The Shore Family',
    description: 'Original settlers. Four generations deep. Control the best fishing waters by tradition.',
    color: '#2d5a3d',
    members: ['marta', 'peter', 'anna', 'bela', 'jakub', 'oldSimao']
  },
  church: {
    name: 'The Church',
    description: 'Positioned as neutral arbiters. The priest holds many secrets.',
    color: '#8a7a50',
    members: ['simao']
  },
  newcomer: {
    name: 'The Newcomers',
    description: 'Arrived within the last decade. Skilled but unintegrated. Carry secrets from the mainland.',
    color: '#5a6a7a',
    members: ['tomas', 'lucia']
  },
  hill: {
    name: 'The Hill Family',
    description: 'Came two generations ago. Trades, crafts, the tavern.',
    color: '#7a6a50',
    members: ['helena']
  }
};

// Get villager by ID
function getVillager(id) {
  return Villagers[id] || null;
}

// Get all villagers in a family
function getFamily(familyId) {
  return Families[familyId]?.members.map(id => Villagers[id]) || [];
}

// Get villager's current dialogue based on trust level
function getDialogue(villagerId, trustLevel) {
  const villager = Villagers[villagerId];
  if (!villager) return null;

  if (trustLevel >= 70) return villager.dialogueBase.trusting;
  if (trustLevel <= 30) return villager.dialogueBase.suspicious;
  return villager.dialogueBase.neutral;
}

// Export
;
}


// === src/js/data/fragments.js ===
// Fragment System for The Lighthouse Keeper

// Fragment types
const FragmentTypes = {
  TONE: 'tone',
  SUBJECT: 'subject',
  ACTION: 'action',
  OBJECT: 'object',
  CONTEXT: 'context'
};

// Base fragments available from the start
const BaseFragments = {
  // TONE fragments - how the entry begins
  tone_official: {
    id: 'tone_official',
    type: FragmentTypes.TONE,
    text: 'It is recorded that',
    description: 'Official, authoritative framing'
  },
  tone_hedged: {
    id: 'tone_hedged',
    type: FragmentTypes.TONE,
    text: 'Reportedly,',
    description: 'Hedged, cautious framing'
  },
  tone_certain: {
    id: 'tone_certain',
    type: FragmentTypes.TONE,
    text: 'Without question,',
    description: 'Certain, definitive framing'
  },
  tone_indicates: {
    id: 'tone_indicates',
    type: FragmentTypes.TONE,
    text: 'The evidence indicates',
    description: 'Evidence-based framing'
  },
  tone_reveals: {
    id: 'tone_reveals',
    type: FragmentTypes.TONE,
    text: 'Testimony reveals',
    description: 'Revealing, exposing framing'
  },
  tone_according: {
    id: 'tone_according',
    type: FragmentTypes.TONE,
    text: 'According to witnesses,',
    description: 'Attributed to others'
  },

  // SUBJECT fragments - who the entry is about
  subject_peter: {
    id: 'subject_peter',
    type: FragmentTypes.SUBJECT,
    text: 'Peter',
    description: 'The fisherman',
    villager: 'peter'
  },
  subject_tomas: {
    id: 'subject_tomas',
    type: FragmentTypes.SUBJECT,
    text: 'Tomas',
    description: 'The boat builder',
    villager: 'tomas'
  },
  subject_shore: {
    id: 'subject_shore',
    type: FragmentTypes.SUBJECT,
    text: 'the shore families',
    description: 'The original settlers'
  },
  subject_newcomers: {
    id: 'subject_newcomers',
    type: FragmentTypes.SUBJECT,
    text: 'the newcomers',
    description: 'Those who came recently'
  },
  subject_dispute: {
    id: 'subject_dispute',
    type: FragmentTypes.SUBJECT,
    text: 'a dispute',
    description: 'The matter in question'
  },
  subject_matter: {
    id: 'subject_matter',
    type: FragmentTypes.SUBJECT,
    text: 'the matter',
    description: 'Vague reference to events'
  },

  // ACTION fragments - what happened
  action_established: {
    id: 'action_established',
    type: FragmentTypes.ACTION,
    text: 'established prior claim',
    description: 'Asserts rightful ownership',
    favor: 'peter',
    against: 'tomas'
  },
  action_contested: {
    id: 'action_contested',
    type: FragmentTypes.ACTION,
    text: 'contested the claim',
    description: 'Challenged ownership',
    favor: 'tomas',
    against: 'peter'
  },
  action_involved: {
    id: 'action_involved',
    type: FragmentTypes.ACTION,
    text: 'was involved in',
    description: 'Neutral participation'
  },
  action_initiated: {
    id: 'action_initiated',
    type: FragmentTypes.ACTION,
    text: 'initiated',
    description: 'Started the conflict',
    damaging: true
  },
  action_caused: {
    id: 'action_caused',
    type: FragmentTypes.ACTION,
    text: 'caused',
    description: 'Bears responsibility',
    damaging: true
  },
  action_responded: {
    id: 'action_responded',
    type: FragmentTypes.ACTION,
    text: 'responded to',
    description: 'Defensive action'
  },
  action_allegedly: {
    id: 'action_allegedly',
    type: FragmentTypes.ACTION,
    text: 'allegedly',
    description: 'Unproven claim'
  },

  // OBJECT fragments - what it concerned
  object_catch: {
    id: 'object_catch',
    type: FragmentTypes.OBJECT,
    text: 'regarding the catch',
    description: 'The fishing dispute'
  },
  object_boat: {
    id: 'object_boat',
    type: FragmentTypes.OBJECT,
    text: 'regarding the boat',
    description: 'The vessel in question'
  },
  object_tradition: {
    id: 'object_tradition',
    type: FragmentTypes.OBJECT,
    text: 'to traditional rights',
    description: 'Customary claims'
  },
  object_harmony: {
    id: 'object_harmony',
    type: FragmentTypes.OBJECT,
    text: 'affecting village harmony',
    description: 'Community impact'
  },
  object_standing: {
    id: 'object_standing',
    type: FragmentTypes.OBJECT,
    text: "to his family's standing",
    description: 'Reputation at stake'
  },

  // CONTEXT fragments - interpretation/framing
  context_accordance: {
    id: 'context_accordance',
    type: FragmentTypes.CONTEXT,
    text: 'in accordance with tradition',
    description: 'Justified by custom',
    favor: 'peter'
  },
  context_despite: {
    id: 'context_despite',
    type: FragmentTypes.CONTEXT,
    text: 'despite warnings',
    description: 'Against advice',
    damaging: true
  },
  context_unclear: {
    id: 'context_unclear',
    type: FragmentTypes.CONTEXT,
    text: '- the causes remain unclear',
    description: 'Ambiguous outcome'
  },
  context_warrant: {
    id: 'context_warrant',
    type: FragmentTypes.CONTEXT,
    text: '- this matter may warrant further attention',
    description: 'Ominous implication'
  },
  context_circumstances: {
    id: 'context_circumstances',
    type: FragmentTypes.CONTEXT,
    text: 'due to circumstances beyond control',
    description: 'Exculpatory framing'
  },
  context_intent: {
    id: 'context_intent',
    type: FragmentTypes.CONTEXT,
    text: 'with apparent intent',
    description: 'Deliberate action implied'
  }
};

// Week-specific fragments that get unlocked through investigation
const WeekFragments = {
  // WEEK 1: The Disputed Catch
  week1: {
    // From talking to Peter
    w1_peter_claim: {
      id: 'w1_peter_claim',
      type: FragmentTypes.SUBJECT,
      text: 'Peter',
      description: 'The fisherman with the traditional claim',
      villager: 'peter',
      unlockedBy: 'talkedToPeter1'
    },
    w1_peter_tradition: {
      id: 'w1_peter_tradition',
      type: FragmentTypes.CONTEXT,
      text: 'and ancestral right',
      description: "Four generations of Peter's family",
      favor: 'peter',
      unlockedBy: 'talkedToPeter1'
    },

    // From talking to Tomas
    w1_tomas_claim: {
      id: 'w1_tomas_claim',
      type: FragmentTypes.SUBJECT,
      text: 'Tomas',
      description: 'The boat builder who contests',
      villager: 'tomas',
      unlockedBy: 'talkedToTomas1'
    },
    w1_tomas_first: {
      id: 'w1_tomas_first',
      type: FragmentTypes.ACTION,
      text: 'secured the catch through seamanship',
      description: 'First net in the water',
      favor: 'tomas',
      unlockedBy: 'talkedToTomas1'
    },
    w1_tomas_net: {
      id: 'w1_tomas_net',
      type: FragmentTypes.CONTEXT,
      text: ', his net being in the water first',
      description: 'Factual claim to the catch',
      favor: 'tomas',
      unlockedBy: 'talkedToTomas1'
    },

    // From consulting Marta
    w1_marta_tradition: {
      id: 'w1_marta_tradition',
      type: FragmentTypes.TONE,
      text: 'By traditional right,',
      description: 'Invoking custom and precedent',
      unlockedBy: 'consultedMarta1'
    },
    w1_shore_waters: {
      id: 'w1_shore_waters',
      type: FragmentTypes.OBJECT,
      text: 'in waters traditionally held by the shore families',
      description: 'Territorial claim',
      favor: 'peter',
      unlockedBy: 'consultedMarta1'
    },

    // From examining evidence
    w1_evidence_both: {
      id: 'w1_evidence_both',
      type: FragmentTypes.ACTION,
      text: 'both parties have legitimate grounds',
      description: 'Ambiguous finding',
      unlockedBy: 'examinedEvidence1',
      memoryTrigger: 'firstRecord'
    },
    w1_evidence_inconclusive: {
      id: 'w1_evidence_inconclusive',
      type: FragmentTypes.CONTEXT,
      text: '- leaving the matter unresolved',
      description: 'No clear resolution',
      unlockedBy: 'examinedEvidence1'
    },

    // Damaging options
    w1_tomas_initiated: {
      id: 'w1_tomas_initiated',
      type: FragmentTypes.ACTION,
      text: 'initiated the dispute',
      description: 'Frames Tomas as aggressor',
      against: 'tomas',
      damaging: true,
      unlockedBy: 'consultedMarta1'
    },
    w1_shore_allegedly: {
      id: 'w1_shore_allegedly',
      type: FragmentTypes.ACTION,
      text: 'allegedly claimed rights to waters not formally assigned',
      description: 'Questions Shore family claims',
      against: 'peter',
      damaging: true,
      unlockedBy: 'talkedToTomas1'
    }
  },

  // WEEK 2: The Priest's Fever
  week2: {
    // From talking to Anna
    w2_anna_report: {
      id: 'w2_anna_report',
      type: FragmentTypes.TONE,
      text: 'The midwife reports that',
      description: 'Medical authority',
      unlockedBy: 'talkedToAnna2'
    },
    w2_simao_ill: {
      id: 'w2_simao_ill',
      type: FragmentTypes.SUBJECT,
      text: 'Father Simao',
      description: 'The village priest',
      villager: 'simao',
      unlockedBy: 'talkedToAnna2'
    },
    w2_fever_serious: {
      id: 'w2_fever_serious',
      type: FragmentTypes.ACTION,
      text: 'fell ill with fever',
      description: 'Simple medical fact',
      unlockedBy: 'talkedToAnna2'
    },
    w2_spoke_delirium: {
      id: 'w2_spoke_delirium',
      type: FragmentTypes.CONTEXT,
      text: 'and spoke of past events during delirium',
      description: 'Hints at revelations',
      sensitive: true,
      unlockedBy: 'talkedToAnna2'
    },

    // From visiting Father Simao
    w2_confession_sealed: {
      id: 'w2_confession_sealed',
      type: FragmentTypes.CONTEXT,
      text: '- certain matters remain sealed by confession',
      description: 'The sacred seal',
      unlockedBy: 'visitedPriest2',
      memoryTrigger: 'theAccused'
    },
    w2_twenty_years: {
      id: 'w2_twenty_years',
      type: FragmentTypes.OBJECT,
      text: 'regarding events of twenty years past',
      description: 'The old secret',
      sensitive: true,
      unlockedBy: 'visitedPriest2'
    },

    // From confronting Marta
    w2_marta_requested: {
      id: 'w2_marta_requested',
      type: FragmentTypes.CONTEXT,
      text: '- certain matters have been requested to remain unrecorded',
      description: "Marta's plea",
      unlockedBy: 'confrontedMarta2'
    },
    w2_peace_over_truth: {
      id: 'w2_peace_over_truth',
      type: FragmentTypes.CONTEXT,
      text: 'in service of village peace',
      description: 'Justification for silence',
      unlockedBy: 'confrontedMarta2'
    },

    // From searching the chapel
    w2_documents_suggest: {
      id: 'w2_documents_suggest',
      type: FragmentTypes.TONE,
      text: 'Documents suggest',
      description: 'Evidence-based revelation',
      unlockedBy: 'searchedChapel2',
      memoryTrigger: 'theEvidence'
    },
    w2_death_reexamine: {
      id: 'w2_death_reexamine',
      type: FragmentTypes.ACTION,
      text: 'the death of Istvan, recorded as accidental, may warrant reexamination',
      description: 'Explosive revelation',
      sensitive: true,
      against: 'marta',
      unlockedBy: 'searchedChapel2'
    },
    w2_historical_inaccuracies: {
      id: 'w2_historical_inaccuracies',
      type: FragmentTypes.OBJECT,
      text: 'that historical records contain significant inaccuracies',
      description: 'Questions the past',
      sensitive: true,
      unlockedBy: 'searchedChapel2'
    },

    // Recovery note
    w2_recovered: {
      id: 'w2_recovered',
      type: FragmentTypes.ACTION,
      text: 'has recovered under care',
      description: 'Simple resolution',
      unlockedBy: 'talkedToAnna2'
    },
    w2_no_substance: {
      id: 'w2_no_substance',
      type: FragmentTypes.CONTEXT,
      text: '- no matters of substance were revealed',
      description: 'Buries the secret',
      unlockedBy: 'visitedPriest2'
    }
  },

  // WEEK 3: The Secret Meetings
  week3: {
    // From talking to Lucia
    w3_lucia: {
      id: 'w3_lucia',
      type: FragmentTypes.SUBJECT,
      text: 'Lucia',
      description: "Tomas's daughter",
      villager: 'lucia',
      unlockedBy: 'talkedToLucia3',
      memoryTrigger: 'theWife'
    },
    w3_attachment: {
      id: 'w3_attachment',
      type: FragmentTypes.ACTION,
      text: 'has formed an attachment',
      description: 'The romance',
      unlockedBy: 'talkedToLucia3'
    },
    w3_potential_unity: {
      id: 'w3_potential_unity',
      type: FragmentTypes.CONTEXT,
      text: 'representing potential unity between families',
      description: 'Positive framing',
      favor: 'lucia',
      unlockedBy: 'talkedToLucia3'
    },

    // From talking to Tomas
    w3_tomas_defended: {
      id: 'w3_tomas_defended',
      type: FragmentTypes.ACTION,
      text: "defended his daughter's character",
      description: "Father's protection",
      favor: 'tomas',
      unlockedBy: 'talkedToTomas3'
    },
    w3_rumors_unfounded: {
      id: 'w3_rumors_unfounded',
      type: FragmentTypes.CONTEXT,
      text: '- rumors appear unfounded',
      description: 'Dismisses concerns',
      favor: 'lucia',
      unlockedBy: 'talkedToTomas3'
    },

    // From hearing Marta's concerns
    w3_concerning_behavior: {
      id: 'w3_concerning_behavior',
      type: FragmentTypes.ACTION,
      text: 'was observed engaging in concerning behavior',
      description: 'Damaging observation',
      against: 'lucia',
      damaging: true,
      unlockedBy: 'heardMarta3'
    },
    w3_warrant_notation: {
      id: 'w3_warrant_notation',
      type: FragmentTypes.CONTEXT,
      text: ', warranting official notation',
      description: 'Makes it permanent',
      against: 'lucia',
      damaging: true,
      unlockedBy: 'heardMarta3'
    },
    w3_unbecoming: {
      id: 'w3_unbecoming',
      type: FragmentTypes.OBJECT,
      text: 'in nocturnal activities unbecoming of her station',
      description: 'Moral judgment',
      against: 'lucia',
      damaging: true,
      unlockedBy: 'heardMarta3'
    },

    // From observing them
    w3_no_concern: {
      id: 'w3_no_concern',
      type: FragmentTypes.ACTION,
      text: 'were observed without matters of concern',
      description: 'Clean observation',
      favor: 'lucia',
      unlockedBy: 'observedThem3'
    },
    w3_personal_conduct: {
      id: 'w3_personal_conduct',
      type: FragmentTypes.OBJECT,
      text: 'regarding personal conduct',
      description: 'Neutral framing',
      unlockedBy: 'observedThem3'
    },
    w3_connection_formed: {
      id: 'w3_connection_formed',
      type: FragmentTypes.TONE,
      text: 'A connection has formed between',
      description: 'Romantic framing',
      unlockedBy: 'observedThem3'
    },
    w3_newcomer_shore: {
      id: 'w3_newcomer_shore',
      type: FragmentTypes.SUBJECT,
      text: 'the newcomer and shore families',
      description: 'The union',
      unlockedBy: 'observedThem3'
    }
  },

  // WEEK 4: The Storm's Toll
  week4: {
    // From hearing Peter's accusation
    w4_peter_vessel: {
      id: 'w4_peter_vessel',
      type: FragmentTypes.SUBJECT,
      text: "Peter's vessel",
      description: 'The destroyed boat',
      villager: 'peter',
      unlockedBy: 'heardPeter4',
      memoryTrigger: 'theEvidence'
    },
    w4_destroyed_failure: {
      id: 'w4_destroyed_failure',
      type: FragmentTypes.ACTION,
      text: "was destroyed due to failure of Tomas's equipment",
      description: 'Blames Tomas',
      against: 'tomas',
      unlockedBy: 'heardPeter4'
    },
    w4_negligence: {
      id: 'w4_negligence',
      type: FragmentTypes.CONTEXT,
      text: 'through negligence in securing the mooring line',
      description: 'Negligence claim',
      against: 'tomas',
      unlockedBy: 'heardPeter4'
    },

    // From hearing Tomas's defense
    w4_tomas_alleged: {
      id: 'w4_tomas_alleged',
      type: FragmentTypes.ACTION,
      text: 'alleged deliberate sabotage',
      description: "Tomas's counter-claim",
      favor: 'tomas',
      unlockedBy: 'heardTomas4'
    },
    w4_rope_cut: {
      id: 'w4_rope_cut',
      type: FragmentTypes.CONTEXT,
      text: '- the rope appears to have been cut',
      description: 'Sabotage evidence',
      favor: 'tomas',
      unlockedBy: 'heardTomas4'
    },
    w4_line_tampered: {
      id: 'w4_line_tampered',
      type: FragmentTypes.ACTION,
      text: "Tomas's mooring line was tampered with",
      description: 'Blames Shore family',
      against: 'peter',
      unlockedBy: 'heardTomas4'
    },

    // From asking Anna
    w4_witness_reported: {
      id: 'w4_witness_reported',
      type: FragmentTypes.TONE,
      text: 'A witness reported',
      description: "Anna's testimony",
      unlockedBy: 'askedAnna4'
    },
    w4_possible_interference: {
      id: 'w4_possible_interference',
      type: FragmentTypes.ACTION,
      text: 'possible interference with the mooring',
      description: 'Uncertain testimony',
      unlockedBy: 'askedAnna4'
    },
    w4_shape_on_dock: {
      id: 'w4_shape_on_dock',
      type: FragmentTypes.CONTEXT,
      text: '- a figure was seen on the dock that night',
      description: 'Mysterious sighting',
      unlockedBy: 'askedAnna4'
    },

    // From examining rope
    w4_evidence_inconclusive: {
      id: 'w4_evidence_inconclusive',
      type: FragmentTypes.ACTION,
      text: 'proved inconclusive regarding specific causes',
      description: 'No clear answer',
      unlockedBy: 'examinedRope4'
    },
    w4_storm_damage: {
      id: 'w4_storm_damage',
      type: FragmentTypes.TONE,
      text: 'Storm damage affected multiple vessels.',
      description: 'Natural explanation',
      unlockedBy: 'examinedRope4'
    },
    w4_physical_evidence: {
      id: 'w4_physical_evidence',
      type: FragmentTypes.SUBJECT,
      text: 'Physical evidence',
      description: 'The rope itself',
      unlockedBy: 'examinedRope4'
    },

    // Sabotage allegation
    w4_deliberate_sabotage: {
      id: 'w4_deliberate_sabotage',
      type: FragmentTypes.TONE,
      text: 'Evidence suggests deliberate sabotage',
      description: 'Serious accusation',
      against: 'tomas',
      damaging: true,
      unlockedBy: 'heardPeter4'
    },
    w4_resulting_destruction: {
      id: 'w4_resulting_destruction',
      type: FragmentTypes.CONTEXT,
      text: ", resulting in destruction of Peter's vessel",
      description: 'The consequence',
      unlockedBy: 'heardPeter4'
    }
  },

  // WEEK 5: The Reckoning
  week5: {
    // Final fragments for village summary
    w5_village_elder: {
      id: 'w5_village_elder',
      type: FragmentTypes.SUBJECT,
      text: 'The village elder',
      description: 'Marta',
      villager: 'marta',
      unlockedBy: 'finalMarta'
    },
    w5_expressed_gratitude: {
      id: 'w5_expressed_gratitude',
      type: FragmentTypes.ACTION,
      text: "expressed gratitude for the Keeper's discretion",
      description: "Marta's thanks",
      favor: 'marta',
      unlockedBy: 'finalMarta'
    },
    w5_tomas_requested: {
      id: 'w5_tomas_requested',
      type: FragmentTypes.ACTION,
      text: "requested fair consideration for his family's future",
      description: "Tomas's appeal",
      favor: 'tomas',
      unlockedBy: 'finalTomas'
    },
    w5_lucia_integrated: {
      id: 'w5_lucia_integrated',
      type: FragmentTypes.ACTION,
      text: 'has integrated well into village life',
      description: "Lucia's success",
      favor: 'lucia',
      unlockedBy: 'finalLucia'
    },
    w5_simao_recovered: {
      id: 'w5_simao_recovered',
      type: FragmentTypes.ACTION,
      text: 'recovered and resumed his duties',
      description: "Father Simao's health",
      unlockedBy: 'finalSimao'
    },

    // Self-documentation
    w5_this_keeper: {
      id: 'w5_this_keeper',
      type: FragmentTypes.SUBJECT,
      text: 'This Keeper',
      description: 'Yourself',
      unlockedBy: 'wroteAboutSelf5'
    },
    w5_served_faithfully: {
      id: 'w5_served_faithfully',
      type: FragmentTypes.ACTION,
      text: 'served faithfully',
      description: 'Positive self-assessment',
      unlockedBy: 'wroteAboutSelf5'
    },
    w5_served_adequately: {
      id: 'w5_served_adequately',
      type: FragmentTypes.ACTION,
      text: 'served adequately',
      description: 'Neutral self-assessment',
      unlockedBy: 'wroteAboutSelf5'
    },
    w5_served_poorly: {
      id: 'w5_served_poorly',
      type: FragmentTypes.ACTION,
      text: 'served with difficulty',
      description: 'Humble self-assessment',
      unlockedBy: 'wroteAboutSelf5'
    },
    w5_documented_truth: {
      id: 'w5_documented_truth',
      type: FragmentTypes.CONTEXT,
      text: ', documenting truth as witnessed',
      description: 'Truth-teller',
      unlockedBy: 'wroteAboutSelf5'
    },
    w5_documented_mercy: {
      id: 'w5_documented_mercy',
      type: FragmentTypes.CONTEXT,
      text: ', showing mercy where possible',
      description: 'Merciful keeper',
      unlockedBy: 'wroteAboutSelf5'
    },
    w5_documented_carefully: {
      id: 'w5_documented_carefully',
      type: FragmentTypes.CONTEXT,
      text: ', recording with care',
      description: 'Careful keeper',
      unlockedBy: 'wroteAboutSelf5'
    }
  }
};

// Get all available fragments for current week based on story flags
function getAvailableFragments(week, storyFlags) {
  const available = [];

  // Add base fragments
  Object.values(BaseFragments).forEach(frag => {
    available.push({ ...frag });
  });

  // Add week-specific fragments that have been unlocked
  const weekKey = `week${week}`;
  if (WeekFragments[weekKey]) {
    Object.values(WeekFragments[weekKey]).forEach(frag => {
      if (!frag.unlockedBy || storyFlags[frag.unlockedBy]) {
        available.push({ ...frag });
      }
    });
  }

  return available;
}

// Get fragments by type
function getFragmentsByType(fragments, type) {
  return fragments.filter(f => f.type === type);
}

// Check if fragment has memory trigger
function checkMemoryTrigger(fragmentId) {
  // Check all week fragments for memory triggers
  for (const weekKey in WeekFragments) {
    for (const fragKey in WeekFragments[weekKey]) {
      const frag = WeekFragments[weekKey][fragKey];
      if (frag.id === fragmentId && frag.memoryTrigger) {
        return frag.memoryTrigger;
      }
    }
  }
  return null;
}

// Export
;
}


// === src/js/data/events.js ===
// Event Data for The Lighthouse Keeper

const Events = {
  // WEEK 1: The Disputed Catch
  1: {
    id: 'week1',
    title: 'The Disputed Catch',
    description: `At dawn, you see two boats returning to the harbor at the same time. Peter's boat and Tomas's boat, racing for the dock. They were at the eastern rocks  traditionally Shore family waters  and they hauled their nets at the same moment.

Three baskets of silver fish. Enough to matter. Both claim the catch.

By midday, the village is taking sides.`,

    involvedVillagers: ['peter', 'tomas', 'marta'],

    actions: [
      {
        id: 'talk_peter_1',
        title: 'Talk to Peter',
        description: 'Hear his claim to the catch based on tradition and bloodline.',
        cost: 1,
        flag: 'talkedToPeter1',
        villager: 'peter',
        testimony: {
          text: `"Four generations, Keeper. Four generations my family has fished those waters. My grandfather taught my father, my father taught me. The eastern rocks  they're ours. Always have been. Everyone knows it."

He pauses, hands tightening on the gunwale of his boat.

"Tomas... he's skilled, I'll give him that. But skill doesn't make tradition. You can't just show up and take what's ours because you got there first one morning."`,
          observation: 'His hands are shaking. Not with anger  with something closer to fear. The boat beneath his fingers is old, worn smooth by generations of hands. This is about more than fish.',
          fragments: ['w1_peter_claim', 'w1_peter_tradition', 'action_established']
        }
      },
      {
        id: 'talk_tomas_1',
        title: 'Talk to Tomas',
        description: 'Hear his claim based on seamanship and fair competition.',
        cost: 1,
        flag: 'talkedToTomas1',
        villager: 'tomas',
        testimony: {
          text: `"I was there first. My net was in the water first. That's how it works on the mainland  first come, first served. Fair."

He meets your eyes steadily.

"I know what they say about me. About us. That we don't belong. But I've been here five years. I build boats for these people. Good boats. Better than they had before."

A long pause.

"I'm not asking for more than I've earned. Just... what I've earned."`,
          observation: 'He looks at you the way you looked at yourself in the mirror, that first morning here. The look of someone who knows they don\'t belong but has nowhere else to go.',
          fragments: ['w1_tomas_claim', 'w1_tomas_first', 'w1_tomas_net', 'action_contested', 'w1_shore_allegedly']
        }
      },
      {
        id: 'consult_marta_1',
        title: 'Consult Marta',
        description: 'The village elder may have perspective on tradition and precedent.',
        cost: 1,
        flag: 'consultedMarta1',
        villager: 'marta',
        testimony: {
          text: `"The eastern rocks have been Shore family waters since before my grandmother's time. There are no documents  we didn't need documents. Everyone knew."

She folds her hands precisely.

"But knowing and recording are different things, aren't they, Keeper? What you write becomes what everyone knows. Or forgets."

Her eyes are unreadable.

"Be careful. This isn't really about fish."`,
          observation: 'She\'s testing you. Watching to see what kind of keeper you\'ll be. Her words about tradition feel rehearsed, but the warning feels genuine.',
          fragments: ['w1_marta_tradition', 'w1_shore_waters', 'w1_tomas_initiated']
        }
      },
      {
        id: 'examine_evidence_1',
        title: 'Examine the Evidence',
        description: 'Look at the boats, the nets, the catch itself. What does the physical evidence suggest?',
        cost: 1,
        flag: 'examinedEvidence1',
        memoryTrigger: 'firstRecord',
        testimony: {
          text: `You examine the boats. Peter's is older  weathered wood, repaired many times. Tomas's is newer, better built. You check the nets. Both show fresh use. The fish in both holds are the same  silver, fresh, caught this morning.

There's no physical evidence that proves anything. Both men could be telling the truth. Both men could be lying. The catch itself doesn't care who owns it.`,
          observation: 'The evidence proves nothing. Your words will have to prove something instead.',
          fragments: ['w1_evidence_both', 'w1_evidence_inconclusive', 'tone_indicates']
        }
      }
    ]
  },

  // WEEK 2: The Priest's Fever
  2: {
    id: 'week2',
    title: "The Priest's Fever",
    description: `Father Simao has collapsed. Fever, coughing blood. Anna tends him but looks worried. The chapel has gone dark.

In his delirium, the priest talks. Names. Dates. The night of the wreck twenty years ago. What Marta's husband really died of.

By midday, Marta has visited the chapel. And then visited you.`,

    involvedVillagers: ['simao', 'anna', 'marta'],

    actions: [
      {
        id: 'talk_anna_2',
        title: 'Talk to Anna',
        description: 'The midwife tends to Father Simao. She may have insights into his condition  and his words.',
        cost: 1,
        flag: 'talkedToAnna2',
        villager: 'anna',
        testimony: {
          text: `"The fever is serious but survivable. He's strong for his age. Too much drink over the years, but strong underneath."

She pauses, washing her hands methodically.

"He's been talking in his sleep. Names I recognize. Henrik  that was Peter's father. Istvan  Marta's husband, dead twenty years now. And something about a confession."

She looks at you directly.

"I thought you should know. In case it matters. In case you need to... decide what to write about it."`,
          observation: 'There\'s something knowing in her eyes. She watches you the way someone watches a familiar face, trying to place it.',
          fragments: ['w2_anna_report', 'w2_simao_ill', 'w2_fever_serious', 'w2_spoke_delirium', 'w2_recovered']
        }
      },
      {
        id: 'visit_priest_2',
        title: 'Visit Father Simao',
        description: 'The priest may share what burdens him  or reveal it in delirium.',
        cost: 2,
        flag: 'visitedPriest2',
        villager: 'simao',
        memoryTrigger: 'theAccused',
        testimony: {
          text: `He's lucid when you arrive, though pale. The wine beside his bed is untouched  perhaps the first time in years.

"Keeper. I wondered when you'd come."

He closes his eyes.

"Twenty years ago, a man confessed to me. What he confessed... it's sealed. Sacred. I can never tell you the words. But I can tell you this: what the village believes about Istvan's death  about Marta's husband  is not the whole truth."

He opens his eyes.

"I've carried this for two decades. If I die... the truth dies with me. I used to think that was mercy. Now I'm not sure."`,
          observation: 'He wants to tell you. The seal of confession binds him, but he\'s found a way to tell you anyway. The question is what you\'ll do with it.',
          fragments: ['w2_confession_sealed', 'w2_twenty_years', 'w2_no_substance']
        }
      },
      {
        id: 'confront_marta_2',
        title: 'Confront Marta',
        description: 'She visited the priest, then came to you. She clearly wants something.',
        cost: 1,
        flag: 'confrontedMarta2',
        villager: 'marta',
        testimony: {
          text: `"You've heard the priest talking. I know you have."

Her composure is perfect, but her hands grip the edge of your desk.

"My husband died twenty years ago. The record says he drowned in a storm. That is the truth that has kept this village together."

She meets your eyes.

"Some truths destroy more than they reveal, Keeper. I'm asking you  not ordering, asking  to let the dead rest. Whatever you think you know... let it stay in the past."

A long pause.

"Please."`,
          observation: 'She knows what happened to her husband. She\'s always known. And she\'s chosen peace over justice, every day for twenty years.',
          fragments: ['w2_marta_requested', 'w2_peace_over_truth']
        }
      },
      {
        id: 'search_chapel_2',
        title: 'Search the Chapel',
        description: 'The priest mentioned documents. Old records might reveal what words cannot.',
        cost: 1,
        flag: 'searchedChapel2',
        memoryTrigger: 'theEvidence',
        testimony: {
          text: `Under the altar, in a box meant for communion supplies, you find papers. Old papers, carefully preserved.

Three names on a list, dated twenty years ago: Istvan. Henrik. Aldric. Beside each name, a number  shares of something split three ways.

Below that, a single line in different handwriting: "God forgive them. God forgive me for knowing and staying silent."

The priest's handwriting. His record of what he could never say aloud.`,
          observation: 'Istvan was Marta\'s husband. Henrik was Peter\'s father. Aldric died last winter. Three men, twenty years ago, the night of a wreck. And now the priest, burning with fever and guilt.',
          fragments: ['w2_documents_suggest', 'w2_death_reexamine', 'w2_historical_inaccuracies']
        }
      }
    ]
  },

  // WEEK 3: The Secret Meetings
  3: {
    id: 'week3',
    title: 'The Secret Meetings',
    description: `Lucia has been seen leaving the village at night. Twice now, returning at dawn. Old Marta has noticed  and she's asked you, pointedly, whether such matters belong in the official record.

What she doesn't know: Lucia is meeting Jakub. Peter's brother. A Shore family boy and a Newcomer girl.

This could be scandal. It could be bridge-building. Your pen decides.`,

    involvedVillagers: ['lucia', 'tomas', 'marta', 'jakub'],

    actions: [
      {
        id: 'talk_lucia_3',
        title: 'Talk to Lucia',
        description: 'Confront her directly about the nighttime departures.',
        cost: 1,
        flag: 'talkedToLucia3',
        villager: 'lucia',
        memoryTrigger: 'theWife',
        testimony: {
          text: `She's terrified when you approach. Then defiant. Then, slowly, something else.

"I'm in love. Is that a crime?"

She wipes her eyes, angry at herself for crying.

"Jakub and I... we've been meeting for six months. He's kind. He sees me  not my father's past, not where I'm from. Just me."

Her voice breaks.

"Please. Don't turn this into something ugly. It's the first thing in my life that feels like it belongs to me."`,
          observation: 'She\'s trusting you with everything. In this moment, you hold her entire future in your hands.',
          fragments: ['w3_lucia', 'w3_attachment', 'w3_potential_unity']
        }
      },
      {
        id: 'talk_tomas_3',
        title: 'Talk to Tomas',
        description: 'Her father may know more than he lets on.',
        cost: 1,
        flag: 'talkedToTomas3',
        villager: 'tomas',
        testimony: {
          text: `"Someone's been spreading rumors about my daughter."

His hands are still, but his jaw is tight.

"I know she's been going out at night. I know who she's meeting. I didn't raise a fool  she chose someone good. Someone who'll protect her."

He looks at you.

"I don't care what you write about me. I've been written about before. But she has a chance to belong here. Really belong. Don't take that from her."`,
          observation: 'He\'s sacrificing himself for her. Whatever you write about him, he\'ll accept. But not about Lucia.',
          fragments: ['w3_tomas_defended', 'w3_rumors_unfounded']
        }
      },
      {
        id: 'hear_marta_3',
        title: "Hear Marta's Concerns",
        description: 'The elder has opinions about proper behavior.',
        cost: 1,
        flag: 'heardMarta3',
        villager: 'marta',
        testimony: {
          text: `"A newcomer's daughter, sneaking around at night. What does that look like, Keeper?"

Her tone is measured, reasonable.

"I'm not saying she's done anything wrong. I'm saying appearances matter. Records matter. If nothing is noted, people draw their own conclusions. But if you were to make an official observation..."

She lets the implication hang.

"Certain behaviors, properly documented, can be useful. In negotiations. In understanding who belongs here and who doesn't."`,
          observation: 'She wants leverage. Not against Lucia specifically  against the future. A documented transgression is a debt that can be called in.',
          fragments: ['w3_concerning_behavior', 'w3_warrant_notation', 'w3_unbecoming']
        }
      },
      {
        id: 'observe_them_3',
        title: 'Observe Them',
        description: 'Watch from a distance. See the truth with your own eyes.',
        cost: 2,
        flag: 'observedThem3',
        testimony: {
          text: `You follow at a distance. Down the cliff path, to the cove where the rocks make a natural shelter.

They're there. Sitting close but not touching. Talking. She laughs at something he says  a real laugh, surprised out of her. He reaches out, hesitant, and takes her hand.

They sit like that for an hour. Two young people, in love, pretending the world outside doesn't exist.

When they part, they don't kiss. They just look at each other. That's almost worse  more intimate, somehow.`,
          observation: 'Whatever else they are, they\'re real. This isn\'t scandal. It\'s just love, with all its terrible vulnerability.',
          fragments: ['w3_no_concern', 'w3_personal_conduct', 'w3_connection_formed', 'w3_newcomer_shore']
        }
      }
    ]
  },

  // WEEK 4: The Storm's Toll
  4: {
    id: 'week4',
    title: "The Storm's Toll",
    description: `A storm last night. The worst of the season. You spent the night keeping the flame alive  literally the lighthouse work you were supposed to do.

By morning, the damage is visible: Peter's boat  his father's boat, his grandfather's boat  is smashed against the rocks. He says Tomas's mooring line snapped and struck it. Tomas says the line was cut.

The village holds its breath. This isn't about a boat. It's about everything.`,

    involvedVillagers: ['peter', 'tomas', 'anna'],

    actions: [
      {
        id: 'hear_peter_4',
        title: "Hear Peter's Accusation",
        description: 'The boat was everything to him. He has someone to blame.',
        cost: 1,
        flag: 'heardPeter4',
        villager: 'peter',
        memoryTrigger: 'theEvidence',
        testimony: {
          text: `"Look at it. LOOK AT IT."

The boat lies broken on the rocks. Three generations of his family, reduced to driftwood.

"His line snapped. Tomas's line. It swung free and hit my mooring, and the surge did the rest."

His voice cracks.

"Maybe it snapped. Maybe he cut it. Either way, it's his fault. His line, his fault. He owes me this. He owes me everything."`,
          observation: 'The boat isn\'t just a boat. It\'s his father, who died. His grandfather, who built it. His identity as a Shore man, a fisherman, someone who belongs.',
          fragments: ['w4_peter_vessel', 'w4_destroyed_failure', 'w4_negligence', 'w4_deliberate_sabotage', 'w4_resulting_destruction']
        }
      },
      {
        id: 'hear_tomas_4',
        title: "Hear Tomas's Defense",
        description: 'He claims the rope was cut. Sabotage.',
        cost: 1,
        flag: 'heardTomas4',
        villager: 'tomas',
        testimony: {
          text: `"I made that rope myself. I know what my ropes can take. That line didn't snap  it was cut."

He shows you the end of the rope. Frayed, yes, but uneven.

"Someone wanted this to happen. Someone wanted to blame me for it."

He's calm, but there's something underneath. The resignation of someone who's been blamed before.

"I know what this looks like. I know what they'll say. But I didn't do this. And I think you know who did."`,
          observation: 'He believes he was framed. The question is whether you believe him  and whether the truth matters more than the peace.',
          fragments: ['w4_tomas_alleged', 'w4_rope_cut', 'w4_line_tampered']
        }
      },
      {
        id: 'ask_anna_4',
        title: 'Ask Anna What She Saw',
        description: 'She was awake last night. She may have seen something.',
        cost: 1,
        flag: 'askedAnna4',
        villager: 'anna',
        testimony: {
          text: `"I couldn't sleep. The storm was so loud, and I was worried about the boats."

She hesitates.

"I went to the window. Just for a moment. And I saw... someone. On the dock. Near Tomas's boat."

Her hands twist together.

"I couldn't see who. The rain was too heavy. But I heard something  metal on rope. And then they were gone."

She looks at you, almost pleading.

"I don't know what I saw. I've thought about it so much it's all confused now. I don't want to accuse anyone of anything."`,
          observation: 'She saw something. But she\'s afraid of what saying it might mean  for the village, for Peter, for herself.',
          fragments: ['w4_witness_reported', 'w4_possible_interference', 'w4_shape_on_dock']
        }
      },
      {
        id: 'examine_rope_4',
        title: 'Examine the Rope',
        description: 'Physical evidence may reveal what words cannot.',
        cost: 1,
        flag: 'examinedRope4',
        testimony: {
          text: `You examine the rope carefully. The end is frayed, the fibers separated and torn.

Could it be stress? Yes. The storm was fierce, the loads enormous. A rope could fail like this.

Could it be cut? Also yes. A blade dragged across rope under tension would produce exactly this pattern.

The evidence is ambiguous. It proves nothing. But you've been here before, haven't you? Ambiguous evidence. A choice that has to be made anyway.`,
          observation: 'The rope doesn\'t tell you what happened. It only tells you that you have to decide what happened.',
          fragments: ['w4_evidence_inconclusive', 'w4_storm_damage', 'w4_physical_evidence']
        }
      }
    ]
  },

  // WEEK 5: The Reckoning
  5: {
    id: 'week5',
    title: 'The Reckoning',
    description: `The supply ship comes at dawn. Your log goes to the mainland. This is your last night.

The villagers know. They come to you  not in a group, but one by one. To appeal. To accept. To be seen one last time before your words about them become permanent.

And you must decide what to write about yourself.`,

    involvedVillagers: ['marta', 'tomas', 'lucia', 'simao', 'bela'],

    actions: [
      {
        id: 'final_marta',
        title: 'Final Words with Marta',
        description: 'The elder comes to say her piece.',
        cost: 1,
        flag: 'finalMarta',
        villager: 'marta',
        requiresState: true // Dialog varies based on prior choices
      },
      {
        id: 'final_tomas',
        title: 'Final Words with Tomas',
        description: 'The newcomer seeks closure.',
        cost: 1,
        flag: 'finalTomas',
        villager: 'tomas',
        requiresState: true
      },
      {
        id: 'final_lucia',
        title: 'Final Words with Lucia',
        description: 'The young woman wants to know her future.',
        cost: 1,
        flag: 'finalLucia',
        villager: 'lucia',
        requiresState: true
      },
      {
        id: 'final_simao',
        title: 'Final Words with Father Simao',
        description: 'The priest has something to say about forgiveness.',
        cost: 1,
        flag: 'finalSimao',
        villager: 'simao',
        requiresState: true
      },
      {
        id: 'write_about_self',
        title: 'Write About Yourself',
        description: 'The final reckoning. Document the Keeper.',
        cost: 2,
        flag: 'wroteAboutSelf5',
        memoryTrigger: 'theName'
      }
    ]
  }
};

// Get event for current week
function getEvent(week) {
  return Events[week] || null;
}

// Get action by ID
function getAction(week, actionId) {
  const event = Events[week];
  if (!event) return null;
  return event.actions.find(a => a.id === actionId) || null;
}

// Generate dynamic dialogue for Week 5 based on game state
function generateWeek5Dialogue(villagerId, storyFlags, villagerStats) {
  const dialogues = {
    marta: {
      buried: {
        text: `"You kept your word, Keeper. The past stays buried."

She's quiet for a moment.

"I'm grateful. More than you know. You gave us peace  gave me peace  when you could have given us truth."

She almost smiles.

"The next Keeper won't know what you know. Perhaps that's a mercy. Perhaps it's a sin. I've stopped trying to tell the difference."`,
        observation: 'She trusts you now. Completely. You carry part of her burden, and she carries part of yours.'
      },
      revealed: {
        text: `"You wrote the truth. I knew you would. I saw it in you from the beginning."

Her voice is hollow but not angry.

"Peter knows now. About his father. About what really happened. I don't know if he'll forgive me for keeping it from him. I don't know if I'd want him to."

She meets your eyes.

"You were right. Truth has its own kind of peace. I just wish it hadn't taken fifty years to find it."`,
        observation: 'She\'s lost something  the peace she\'d built from silence. But there\'s something in her eyes that might be relief.'
      }
    },
    tomas: {
      protected: {
        text: `"You could have destroyed me. More than once. You didn't."

He's quiet, working on something small  a piece of wood, half-carved.

"I came here running from something. I think you did too. We recognized each other, that first day."

He looks up.

"I'm staying. Lucia's staying. Maybe we'll finally stop being newcomers. Maybe we'll just be... people. Who belong."`,
        observation: 'He\'s found what he was looking for. A place to stop running.'
      },
      destroyed: {
        text: `"I'm leaving. Tomorrow, with the supply ship."

He's packing. The house is half-empty.

"You did what you had to do. I understand that. Records matter. Truth matters. I just wish..."

He stops.

"Take care of Lucia. Please. She's choosing to stay. For Jakub. Don't let them destroy her the way they destroyed me."`,
        observation: 'He\'s not angry. That\'s almost worse. He\'s just... tired. Done running and done fighting.'
      }
    },
    lucia: {
      protected: {
        text: `"We're getting married. Jakub and I. Next spring."

She's crying, but smiling too.

"You gave us that. When you could have taken it away, you gave us a chance. I don't know how to thank you for that."

She takes your hand.

"I'll remember you. When I'm old, and my children ask about the Keeper who was here when I was young, I'll tell them: they were kind. They saw people, not records."`,
        observation: 'She shines. This is what hope looks like, when you don\'t crush it.'
      },
      exposed: {
        text: `"I'm leaving with my father. There's nothing here for me now."

She won't look at you.

"Jakub tried. He fought for me. But his family... your record... it was too much. I was too much."

Her voice breaks.

"I trusted you. I told you everything, and you wrote it down for everyone to see. I'll never trust anyone again."`,
        observation: 'She\'s broken. Not angry  broken. You did this.'
      }
    },
    simao: {
      healed: {
        text: `"I survived. God, in His mystery, has given me more time."

He pours you wine. His hand is steadier now.

"I've been thinking about forgiveness. Yours. Mine. Theirs."

He drinks.

"You carry something, Keeper. I see it in you. Whatever you did  before, wherever before was  it's not the only thing you are. The man who keeps the light, who writes the record... he matters too."`,
        observation: 'It\'s not absolution. But it\'s something close.'
      },
      default: {
        text: `"The record goes out tomorrow. Your words become permanent."

He studies his wine.

"I've carried secrets my whole life. They don't get lighter. But they do become part of you, after enough time. Part of how you see the world."

He looks at you.

"What will you write about yourself, Keeper? What truth, what mercy, what silence?"`,
        observation: 'He\'s asking the only question that matters now.'
      }
    }
  };

  // Select appropriate dialogue based on state
  if (villagerId === 'marta') {
    return storyFlags.secretRevealed ? dialogues.marta.revealed : dialogues.marta.buried;
  }
  if (villagerId === 'tomas') {
    if (storyFlags.blamedTomas || storyFlags.sabotageAlleged || villagerStats.tomas.wellbeing < 30) {
      return dialogues.tomas.destroyed;
    }
    return dialogues.tomas.protected;
  }
  if (villagerId === 'lucia') {
    return storyFlags.luciaExposed ? dialogues.lucia.exposed : dialogues.lucia.protected;
  }
  if (villagerId === 'simao') {
    return storyFlags.priestConfided ? dialogues.simao.healed : dialogues.simao.default;
  }

  return null;
}

// Generate Bela's final dialogue based on player actions
function generateBelaDialogue(storyFlags) {
  const { truthCount, mercyCount, selfServingCount } = storyFlags;

  // Determine player archetype
  if (truthCount > mercyCount && truthCount > selfServingCount) {
    return {
      text: `"You wrote true. Not kind, but true."

He's watching you with those strange, unblinking eyes.

"The village needed someone who would do that. Even when it hurt. Even when they begged you not to."

He pauses.

"I'll be the next Keeper, someday. They don't know it yet. But I will. And I'll remember what you did. How you chose truth over comfort. Over peace."

He almost smiles.

"It's not easy, is it? Being the one who writes it down."`,
      observation: 'He sees you. Really sees you. And he respects what he sees.'
    };
  }

  if (mercyCount > truthCount && mercyCount > selfServingCount) {
    return {
      text: `"You wrote kind. Not true, but kind."

He looks at you without judgment.

"Maybe that's what the village needed. Someone who would let them live with themselves. Let them keep their secrets."

He pauses.

"I'll be the next Keeper, someday. And I'll remember what you chose. Mercy over truth. Peace over justice."

A long silence.

"I don't know if it was right. I don't know if you do either. But it was something. It meant something to the people you protected."`,
      observation: 'He understands. He doesn\'t agree, perhaps, but he understands.'
    };
  }

  if (selfServingCount >= truthCount && selfServingCount >= mercyCount) {
    return {
      text: `"You wrote what was easy. What kept you safe."

His voice is flat. Not angry  something worse.

"I watched you choose yourself. Every time. When Peter needed justice, when Lucia needed protection, when the village needed truth  you chose yourself."

He stands to leave.

"I'll be the next Keeper. I've been watching. Learning. What you taught me is this: the pen is a weapon, and you used it like a coward."

He's gone before you can respond.`,
      observation: 'He saw everything. Judged everything. And found you wanting.'
    };
  }

  // Inconsistent
  return {
    text: `"I don't understand you."

He sits across from you, studying your face like a text he can't quite read.

"Sometimes true, sometimes kind, sometimes neither. You protected Lucia but hurt Tomas. You buried one secret and revealed another."

He shakes his head.

"I'll be the next Keeper, someday. I've been watching, trying to learn. But I don't know what to learn from you."

A pause.

"What were you trying to do, Keeper? What were you trying to be?"`,
    observation: 'He\'s confused by you. Your inconsistency troubles him more than cruelty or cowardice would.'
  };
}

// Export
;
}


// === src/js/systems/state.js ===
// State Management System for The Lighthouse Keeper

const GameState = {
  // Core progress
  week: 1,
  phase: 'dawn', // dawn, day, dusk, night
  timeRemaining: 4, // Investigation hours available

  // Villager states
  villagers: {
    marta: { wellbeing: 60, trust: 50 },
    peter: { wellbeing: 65, trust: 45 },
    anna: { wellbeing: 70, trust: 65 },
    tomas: { wellbeing: 55, trust: 40 },
    lucia: { wellbeing: 70, trust: 50 },
    simao: { wellbeing: 60, trust: 55 },
    bela: { wellbeing: 65, trust: 60 },
    jakub: { wellbeing: 70, trust: 45 },
    helena: { wellbeing: 65, trust: 50 },
    oldSimao: { wellbeing: 50, trust: 55 }
  },

  // Story flags
  story: {
    // Week 1
    catchVerdict: null, // "peter" | "tomas" | "neutral" | "damaging"
    talkedToPeter1: false,
    talkedToTomas1: false,
    consultedMarta1: false,
    examinedEvidence1: false,

    // Week 2
    secretRevealed: false,
    documentsFound: false,
    priestConfided: false,
    talkedToAnna2: false,
    visitedPriest2: false,
    confrontedMarta2: false,
    searchedChapel2: false,

    // Week 3
    luciaExposed: false,
    luciaProtected: false,
    luciaRomanceBlessed: false,
    talkedToLucia3: false,
    talkedToTomas3: false,
    heardMarta3: false,
    observedThem3: false,

    // Week 4
    blamedTomas: false,
    blamedPeter: false,
    blamedNoOne: false,
    sabotageAlleged: false,
    annaTestified: false,
    heardPeter4: false,
    heardTomas4: false,
    askedAnna4: false,
    examinedRope4: false,

    // Week 5
    wroteAboutSelf: false,
    signedLog: null, // true = signed, false = unsigned, null = not decided
    finalMarta: false,
    finalTomas: false,
    finalLucia: false,
    finalSimao: false,
    wroteAboutSelf5: false,

    // Cumulative
    tension: 20,
    truthCount: 0,
    mercyCount: 0,
    selfServingCount: 0
  },

  // Keeper memories unlocked
  memories: {
    firstRecord: false,
    theAccused: false,
    theWife: false,
    theEvidence: false,
    theName: false
  },

  // Current week state
  current: {
    fragments: [],
    usedFragments: new Set(),
    completedActions: new Set(),
    entry: {
      tone: null,
      subject: null,
      action: null,
      object: null,
      context: null
    }
  },

  // Complete log of all entries
  log: [],

  // UI state
  ui: {
    selectedVillager: null,
    activeModal: null,
    audioEnabled: false,
    reducedMotion: false
  }
};

// State management functions
const StateManager = {
  // Get current state (returns reference - be careful with mutation)
  getState() {
    return GameState;
  },

  // Update villager stats
  updateVillager(villagerId, stat, delta) {
    if (GameState.villagers[villagerId]) {
      GameState.villagers[villagerId][stat] = Math.max(0, Math.min(100,
        GameState.villagers[villagerId][stat] + delta
      ));
      this.emit('villagerUpdate', { villagerId, stat, value: GameState.villagers[villagerId][stat] });
    }
  },

  // Set story flag
  setStoryFlag(flag, value) {
    if (flag in GameState.story) {
      GameState.story[flag] = value;
      this.emit('storyFlagUpdate', { flag, value });
    }
  },

  // Update tension
  updateTension(delta) {
    GameState.story.tension = Math.max(0, Math.min(100, GameState.story.tension + delta));
    this.emit('tensionUpdate', GameState.story.tension);
  },

  // Add fragment to current collection
  addFragment(fragment) {
    if (!GameState.current.fragments.find(f => f.id === fragment.id)) {
      GameState.current.fragments.push(fragment);
      this.emit('fragmentAdded', fragment);
    }
  },

  // Place fragment in entry slot
  placeFragment(slot, fragment) {
    if (fragment && GameState.current.entry[slot] !== undefined) {
      // Remove from previous slot if exists
      Object.keys(GameState.current.entry).forEach(s => {
        if (GameState.current.entry[s]?.id === fragment.id) {
          GameState.current.entry[s] = null;
        }
      });

      GameState.current.entry[slot] = fragment;
      GameState.current.usedFragments.add(fragment.id);
      this.emit('fragmentPlaced', { slot, fragment });
    }
  },

  // Remove fragment from slot
  removeFragment(slot) {
    const fragment = GameState.current.entry[slot];
    if (fragment) {
      GameState.current.usedFragments.delete(fragment.id);
      GameState.current.entry[slot] = null;
      this.emit('fragmentRemoved', { slot, fragment });
    }
  },

  // Mark investigation action as complete
  completeAction(actionId) {
    GameState.current.completedActions.add(actionId);
    this.emit('actionCompleted', actionId);
  },

  // Use time for investigation
  useTime(hours) {
    GameState.timeRemaining = Math.max(0, GameState.timeRemaining - hours);
    this.emit('timeUpdate', GameState.timeRemaining);
    return GameState.timeRemaining;
  },

  // Unlock memory
  unlockMemory(memoryId) {
    if (memoryId in GameState.memories && !GameState.memories[memoryId]) {
      GameState.memories[memoryId] = true;
      this.emit('memoryUnlocked', memoryId);
      return true;
    }
    return false;
  },

  // Submit entry and advance
  submitEntry() {
    const entry = { ...GameState.current.entry };
    const composedText = this.composeEntryText();

    GameState.log.push({
      week: GameState.week,
      entry: entry,
      text: composedText,
      timestamp: Date.now()
    });

    this.emit('entrySubmitted', { entry, text: composedText });
    return { entry, text: composedText };
  },

  // Compose entry text from fragments
  composeEntryText() {
    const e = GameState.current.entry;
    const parts = [];

    if (e.tone) parts.push(e.tone.text);
    if (e.subject) parts.push(e.subject.text);
    if (e.action) parts.push(e.action.text);
    if (e.object) parts.push(e.object.text);
    if (e.context) parts.push(e.context.text);

    return parts.join(' ').trim() + '.';
  },

  // Check if entry is complete
  isEntryComplete() {
    const e = GameState.current.entry;
    return e.subject !== null && e.action !== null;
  },

  // Advance to next phase
  advancePhase() {
    const phases = ['dawn', 'day', 'dusk', 'night'];
    const currentIndex = phases.indexOf(GameState.phase);

    if (currentIndex < phases.length - 1) {
      GameState.phase = phases[currentIndex + 1];
    } else {
      // Move to next week
      this.advanceWeek();
    }

    this.emit('phaseChange', GameState.phase);
  },

  // Advance to next week
  advanceWeek() {
    if (GameState.week < 5) {
      GameState.week++;
      GameState.phase = 'dawn';
      GameState.timeRemaining = 4;
      GameState.current = {
        fragments: [],
        usedFragments: new Set(),
        completedActions: new Set(),
        entry: {
          tone: null,
          subject: null,
          action: null,
          object: null,
          context: null
        }
      };
      this.emit('weekChange', GameState.week);
    } else {
      this.emit('gameEnd');
    }
  },

  // Reset game
  reset() {
    Object.assign(GameState, {
      week: 1,
      phase: 'dawn',
      timeRemaining: 4,
      villagers: {
        marta: { wellbeing: 60, trust: 50 },
        peter: { wellbeing: 65, trust: 45 },
        anna: { wellbeing: 70, trust: 65 },
        tomas: { wellbeing: 55, trust: 40 },
        lucia: { wellbeing: 70, trust: 50 },
        simao: { wellbeing: 60, trust: 55 },
        bela: { wellbeing: 65, trust: 60 },
        jakub: { wellbeing: 70, trust: 45 },
        helena: { wellbeing: 65, trust: 50 },
        oldSimao: { wellbeing: 50, trust: 55 }
      },
      story: {
        catchVerdict: null,
        talkedToPeter1: false,
        talkedToTomas1: false,
        consultedMarta1: false,
        examinedEvidence1: false,
        secretRevealed: false,
        documentsFound: false,
        priestConfided: false,
        talkedToAnna2: false,
        visitedPriest2: false,
        confrontedMarta2: false,
        searchedChapel2: false,
        luciaExposed: false,
        luciaProtected: false,
        luciaRomanceBlessed: false,
        talkedToLucia3: false,
        talkedToTomas3: false,
        heardMarta3: false,
        observedThem3: false,
        blamedTomas: false,
        blamedPeter: false,
        blamedNoOne: false,
        sabotageAlleged: false,
        annaTestified: false,
        heardPeter4: false,
        heardTomas4: false,
        askedAnna4: false,
        examinedRope4: false,
        wroteAboutSelf: false,
        signedLog: null,
        finalMarta: false,
        finalTomas: false,
        finalLucia: false,
        finalSimao: false,
        wroteAboutSelf5: false,
        tension: 20,
        truthCount: 0,
        mercyCount: 0,
        selfServingCount: 0
      },
      memories: {
        firstRecord: false,
        theAccused: false,
        theWife: false,
        theEvidence: false,
        theName: false
      },
      current: {
        fragments: [],
        usedFragments: new Set(),
        completedActions: new Set(),
        entry: {
          tone: null,
          subject: null,
          action: null,
          object: null,
          context: null
        }
      },
      log: [],
      ui: {
        selectedVillager: null,
        activeModal: null,
        audioEnabled: false,
        reducedMotion: false
      }
    });
    this.emit('gameReset');
  },

  // Simple event system
  _listeners: {},

  on(event, callback) {
    if (!this._listeners[event]) {
      this._listeners[event] = [];
    }
    this._listeners[event].push(callback);
  },

  off(event, callback) {
    if (this._listeners[event]) {
      this._listeners[event] = this._listeners[event].filter(cb => cb !== callback);
    }
  },

  emit(event, data) {
    if (this._listeners[event]) {
      this._listeners[event].forEach(callback => callback(data));
    }
  },

  // Save/Load (localStorage)
  save() {
    const saveData = {
      ...GameState,
      current: {
        ...GameState.current,
        usedFragments: Array.from(GameState.current.usedFragments),
        completedActions: Array.from(GameState.current.completedActions)
      }
    };
    localStorage.setItem('lighthouseKeeper_save', JSON.stringify(saveData));
  },

  load() {
    const saved = localStorage.getItem('lighthouseKeeper_save');
    if (saved) {
      const data = JSON.parse(saved);
      data.current.usedFragments = new Set(data.current.usedFragments);
      data.current.completedActions = new Set(data.current.completedActions);
      Object.assign(GameState, data);
      this.emit('gameLoaded');
      return true;
    }
    return false;
  },

  hasSave() {
    return localStorage.getItem('lighthouseKeeper_save') !== null;
  },

  clearSave() {
    localStorage.removeItem('lighthouseKeeper_save');
  }
};

// Export for module use
;
}


// === src/js/systems/story.js ===
// Story System for The Lighthouse Keeper

const StorySystem = {
  // Get current event with dynamic modifications based on story state
  getCurrentEvent(week, storyFlags, villagerStats) {
    const baseEvent = getEvent(week);
    if (!baseEvent) return null;

    // Clone to avoid mutating original
    const event = JSON.parse(JSON.stringify(baseEvent));

    // Modify description based on prior choices
    event.description = this.modifyDescription(event.description, week, storyFlags);

    // Modify actions based on state
    event.actions = event.actions.map(action => {
      return this.modifyAction(action, week, storyFlags, villagerStats);
    });

    return event;
  },

  // Modify event description based on prior choices
  modifyDescription(baseDescription, week, storyFlags) {
    let description = baseDescription;

    if (week === 2) {
      if (storyFlags.catchVerdict === 'peter') {
        description += '\n\nYou remember last week  how you ruled in favor of Peter. Tomas watches you now with guarded eyes.';
      } else if (storyFlags.catchVerdict === 'tomas') {
        description += '\n\nPeter has been drinking more since your ruling last week. He avoids looking at you.';
      }
    }

    if (week === 3) {
      if (storyFlags.secretRevealed) {
        description += '\n\nThe village is still reeling from what the priest revealed in his fever. Old wounds have reopened.';
      }
    }

    if (week === 4) {
      if (storyFlags.luciaExposed) {
        description += '\n\nLucia and Jakub have been forced apart. You see her sometimes, walking alone along the cliffs. She doesn\'t wave.';
      } else if (storyFlags.luciaProtected) {
        description += '\n\nYou\'ve seen Lucia and Jakub together more openly now. There\'s talk of an announcement.';
      }

      if (storyFlags.catchVerdict === 'damaging') {
        description += '\n\nThe tension between Shore and Newcomer has only grown since the catch dispute. Tonight\'s storm feels like a breaking point.';
      }
    }

    if (week === 5) {
      // Add summary of village state
      const tensionLevel = storyFlags.tension;
      if (tensionLevel >= 80) {
        description += '\n\nThe village is fractured. You see it in how people walk  giving wide berths, avoiding eyes. What you write tonight will define this place for years.';
      } else if (tensionLevel >= 50) {
        description += '\n\nTensions run high, but the village holds. People still greet each other, still trade, still pray together. There\'s hope, if fragile.';
      } else {
        description += '\n\nDespite everything, the village endures. There\'s warmth in the tavern, laughter by the boats. You\'ve helped keep something alive here.';
      }
    }

    return description;
  },

  // Modify action based on prior state
  modifyAction(action, week, storyFlags, villagerStats) {
    const modified = { ...action };

    // Check if action requires specific state
    if (modified.requiresState && week === 5) {
      modified.testimony = this.generateWeek5Testimony(modified.villager, storyFlags, villagerStats);
    }

    // Modify dialogue based on relationship
    if (modified.villager && modified.testimony) {
      const stats = villagerStats[modified.villager];
      if (stats) {
        if (stats.trust < 30) {
          modified.testimony = this.addSuspicion(modified.testimony, modified.villager);
        } else if (stats.trust > 70) {
          modified.testimony = this.addWarmth(modified.testimony, modified.villager);
        }
      }
    }

    // Week-specific modifications
    if (week === 4 && modified.villager === 'tomas') {
      if (storyFlags.catchVerdict === 'peter') {
        modified.testimony = this.modifyTomasWeek4Bitter(modified.testimony);
      } else if (storyFlags.catchVerdict === 'tomas') {
        modified.testimony = this.modifyTomasWeek4Hopeful(modified.testimony);
      }
    }

    return modified;
  },

  // Generate Week 5 testimony based on state
  generateWeek5Testimony(villagerId, storyFlags, villagerStats) {
    const dialogue = generateWeek5Dialogue(villagerId, storyFlags, villagerStats);
    if (!dialogue) return null;

    return {
      text: dialogue.text,
      observation: dialogue.observation,
      fragments: this.getWeek5Fragments(villagerId)
    };
  },

  // Get fragments available from Week 5 conversations
  getWeek5Fragments(villagerId) {
    const fragmentMap = {
      marta: ['w5_village_elder', 'w5_expressed_gratitude'],
      tomas: ['w5_tomas_requested'],
      lucia: ['w5_lucia_integrated'],
      simao: ['w5_simao_recovered']
    };
    return fragmentMap[villagerId] || [];
  },

  // Add suspicion overlay to testimony
  addSuspicion(testimony, villagerId) {
    if (!testimony) return testimony;

    const suspiciousAdditions = {
      peter: '\n\nHe watches you with hard eyes. Whatever goodwill might have existed is gone.',
      tomas: '\n\nHe keeps his distance, speaking formally. Trust, once broken, doesn\'t easily mend.',
      marta: '\n\nShe weighs every word carefully, giving nothing away. You\'ve proven yourself untrustworthy.',
      lucia: '\n\nShe flinches when you approach. The girl who trusted you is gone.',
      anna: '\n\nHer warmth has cooled. She knows what you are now.',
      simao: '\n\nHe offers wine, but his eyes are guarded. Even priests can lose faith in people.'
    };

    return {
      ...testimony,
      observation: testimony.observation + (suspiciousAdditions[villagerId] || '')
    };
  },

  // Add warmth overlay to testimony
  addWarmth(testimony, villagerId) {
    if (!testimony) return testimony;

    const warmAdditions = {
      peter: '\n\nThere\'s genuine respect in his voice now. You\'ve earned your place here.',
      tomas: '\n\nHe speaks to you like a friend. In his eyes, you see recognition  one outcast to another.',
      marta: '\n\nShe almost smiles. You\'ve proven yourself. The tests are over.',
      lucia: '\n\nShe takes your hand without thinking. You\'ve become someone she trusts.',
      anna: '\n\nShe looks at you differently now  like an equal, a confidant.',
      simao: '\n\nHe pours you the good wine. Some things don\'t need to be said.'
    };

    return {
      ...testimony,
      observation: testimony.observation + (warmAdditions[villagerId] || '')
    };
  },

  // Modify Tomas's Week 4 dialogue if he was betrayed in Week 1
  modifyTomasWeek4Bitter(testimony) {
    if (!testimony) return testimony;

    const bitterPreamble = `His voice is flat when he sees you.

"Back again. To write another record, I suppose. To decide another fate."

He doesn\'t look at you as he speaks.

`;

    return {
      ...testimony,
      text: bitterPreamble + testimony.text
    };
  },

  // Modify Tomas's Week 4 dialogue if he was supported in Week 1
  modifyTomasWeek4Hopeful(testimony) {
    if (!testimony) return testimony;

    const hopefulPreamble = `He greets you with a nod  almost warm.

"You were fair with me once. I hope you\'ll be fair now."

`;

    return {
      ...testimony,
      text: hopefulPreamble + testimony.text
    };
  },

  // Check available actions based on time
  getAvailableActions(event, timeRemaining, completedActions) {
    return event.actions.filter(action => {
      // Already completed
      if (completedActions.has(action.id)) return false;

      // Not enough time
      if (action.cost > timeRemaining) return false;

      return true;
    });
  },

  // Check if the week can be completed
  canCompleteWeek(entry) {
    // Need at least subject and action to submit
    return entry.subject !== null && entry.action !== null;
  },

  // Get ending type based on final state
  calculateEnding(storyFlags, villagerStats) {
    // Village state
    let villageEnding;
    if (storyFlags.tension >= 80) {
      villageEnding = 'collapse';
    } else if (storyFlags.tension >= 50) {
      villageEnding = 'fracture';
    } else if (storyFlags.tension >= 30) {
      villageEnding = 'endurance';
    } else {
      villageEnding = 'peace';
    }

    // Keeper archetype
    let keeperEnding;
    const { truthCount, mercyCount, selfServingCount } = storyFlags;
    if (truthCount > mercyCount && truthCount > selfServingCount) {
      keeperEnding = 'honest';
    } else if (mercyCount > truthCount && mercyCount > selfServingCount) {
      keeperEnding = 'merciful';
    } else if (selfServingCount >= truthCount && selfServingCount >= mercyCount && selfServingCount > 0) {
      keeperEnding = 'corrupt';
    } else {
      keeperEnding = 'inconsistent';
    }

    // Secret state
    const secretEnding = storyFlags.secretRevealed ? 'revealed' : 'buried';

    // Signature state
    const signatureEnding = storyFlags.signedLog ? 'signed' : 'unsigned';

    return {
      village: villageEnding,
      keeper: keeperEnding,
      secret: secretEnding,
      signature: signatureEnding
    };
  },

  // Generate ending text
  generateEndingText(ending) {
    const texts = {
      'peace-merciful-buried-signed': `You kept the light burning and the village whole. You protected them from truths that would have destroyed them. Your name is on a record full of kind omissions. You can live with that. Most nights.`,

      'peace-merciful-buried-unsigned': `The village thrives in its gentle ignorance. You let them keep their peace, their secrets, their illusions. No one will know who wrote these records  perhaps that's its own kind of mercy.`,

      'fracture-honest-revealed-signed': `You wrote what was true. The village cracked under the weight of it. They'll rebuild, or they won't. Your name is on every word. You own this truth.`,

      'fracture-honest-revealed-unsigned': `The truth is out now, burning through old wounds. You didn't sign your name  perhaps you couldn't bear to. The village knows what happened, but not who told them.`,

      'collapse-corrupt-buried-signed': `The village is empty now. They left, or turned on each other, or simply gave up. You survived  you made sure of that. Your name is on a record that tells a story no one will read, about a place that no longer exists.`,

      'endurance-inconsistent-buried-unsigned': `The village continues, neither thriving nor dying. Your records tell a confused story  mercy here, cruelty there, truth and lies braided together. Perhaps that's the most honest record of all.`
    };

    const key = `${ending.village}-${ending.keeper}-${ending.secret}-${ending.signature}`;
    return texts[key] || this.generateGenericEnding(ending);
  },

  // Generate generic ending if specific combination not found
  generateGenericEnding(ending) {
    let text = '';

    // Village state
    switch (ending.village) {
      case 'peace':
        text += 'The village endures, finding something like peace. ';
        break;
      case 'endurance':
        text += 'The village survives, neither thriving nor dying. ';
        break;
      case 'fracture':
        text += 'The village is divided, wounds fresh and unhealed. ';
        break;
      case 'collapse':
        text += 'What was once a village is now just buildings. The people have scattered or turned inward. ';
        break;
    }

    // Keeper archetype
    switch (ending.keeper) {
      case 'honest':
        text += 'You wrote the truth, whatever the cost. ';
        break;
      case 'merciful':
        text += 'You chose kindness over clarity. ';
        break;
      case 'corrupt':
        text += 'You protected yourself above all else. ';
        break;
      case 'inconsistent':
        text += 'Your records tell no consistent story  perhaps neither do you. ';
        break;
    }

    // Secret
    if (ending.secret === 'revealed') {
      text += 'The old secret is out now, burning through generations of silence. ';
    } else {
      text += 'The old secret stays buried, carried now by you as well. ';
    }

    // Signature
    if (ending.signature === 'signed') {
      text += 'Your name stands at the end of every entry. You own this record.';
    } else {
      text += 'Your name appears nowhere. The Keeper who wrote these words could be anyone.';
    }

    return text;
  }
};

// Export
;
}


// === src/js/systems/consequence.js ===
// Consequence Engine for The Lighthouse Keeper

const ConsequenceEngine = {
  // Calculate all consequences from an entry
  calculateConsequences(entry, week, storyFlags) {
    const effects = [];

    // Get fragment IDs from entry
    const fragments = Object.values(entry).filter(Boolean);

    // Process each fragment for effects
    fragments.forEach(frag => {
      // Direct villager effects
      if (frag.favor) {
        effects.push({
          type: 'villager',
          target: frag.favor,
          stat: 'wellbeing',
          delta: 10,
          reason: `Your record supports ${frag.favor}'s position.`
        });
        effects.push({
          type: 'villager',
          target: frag.favor,
          stat: 'trust',
          delta: 8,
          reason: `${frag.favor} trusts you more for supporting them.`
        });
      }

      if (frag.against) {
        effects.push({
          type: 'villager',
          target: frag.against,
          stat: 'wellbeing',
          delta: -15,
          reason: `Your record harms ${frag.against}'s standing.`
        });
        effects.push({
          type: 'villager',
          target: frag.against,
          stat: 'trust',
          delta: -12,
          reason: `${frag.against} feels betrayed by your record.`
        });
      }

      if (frag.damaging) {
        effects.push({
          type: 'tension',
          delta: 8,
          reason: 'Your record increases village tension.'
        });
      }

      if (frag.sensitive) {
        effects.push({
          type: 'story',
          flag: 'secretRevealed',
          value: true,
          reason: 'Sensitive matters have been recorded.'
        });
        effects.push({
          type: 'villager',
          target: 'marta',
          stat: 'trust',
          delta: -25,
          reason: 'Marta trusted you to keep the past buried.'
        });
        effects.push({
          type: 'tension',
          delta: 15,
          reason: 'Old secrets surface, destabilizing the village.'
        });
      }
    });

    // Week-specific consequences
    const weekEffects = this.getWeekSpecificEffects(entry, week, storyFlags);
    effects.push(...weekEffects);

    // Track player archetype
    const archetypeEffects = this.trackArchetype(entry, storyFlags);
    effects.push(...archetypeEffects);

    return effects;
  },

  // Get week-specific effects
  getWeekSpecificEffects(entry, week, storyFlags) {
    const effects = [];
    const fragIds = Object.values(entry).filter(Boolean).map(f => f.id);

    switch (week) {
      case 1: // Disputed Catch
        if (fragIds.includes('action_established') || fragIds.includes('w1_peter_claim')) {
          effects.push({
            type: 'story',
            flag: 'catchVerdict',
            value: 'peter',
            reason: 'You ruled in favor of Peter.'
          });
          effects.push({
            type: 'faction',
            target: 'shore',
            delta: 10,
            reason: 'Shore family influence grows.'
          });
          effects.push({
            type: 'faction',
            target: 'newcomer',
            delta: -10,
            reason: 'Newcomers feel the system is rigged.'
          });
        } else if (fragIds.includes('w1_tomas_first') || fragIds.includes('w1_tomas_claim')) {
          effects.push({
            type: 'story',
            flag: 'catchVerdict',
            value: 'tomas',
            reason: 'You ruled in favor of Tomas.'
          });
          effects.push({
            type: 'faction',
            target: 'newcomer',
            delta: 10,
            reason: 'Newcomers gain standing.'
          });
          effects.push({
            type: 'faction',
            target: 'shore',
            delta: -8,
            reason: 'Shore family resents the outsider.'
          });
        } else if (fragIds.includes('w1_evidence_both') || fragIds.includes('w1_evidence_inconclusive')) {
          effects.push({
            type: 'story',
            flag: 'catchVerdict',
            value: 'neutral',
            reason: 'You left the matter unresolved.'
          });
          effects.push({
            type: 'tension',
            delta: 10,
            reason: 'The conflict festers without resolution.'
          });
        } else if (fragIds.includes('w1_tomas_initiated') || fragIds.includes('w1_shore_allegedly')) {
          effects.push({
            type: 'story',
            flag: 'catchVerdict',
            value: 'damaging',
            reason: 'Your record damages reputations.'
          });
          effects.push({
            type: 'tension',
            delta: 15,
            reason: 'Accusations breed resentment.'
          });
        }
        break;

      case 2: // Priest's Fever
        if (fragIds.includes('w2_death_reexamine') || fragIds.includes('w2_historical_inaccuracies')) {
          effects.push({
            type: 'villager',
            target: 'peter',
            stat: 'wellbeing',
            delta: -20,
            reason: 'Peter learns the truth about his father.'
          });
          effects.push({
            type: 'villager',
            target: 'peter',
            stat: 'trust',
            delta: -15,
            reason: 'Peter blames you for revealing his shame.'
          });
        }

        if (fragIds.includes('w2_recovered') && !fragIds.includes('w2_spoke_delirium')) {
          effects.push({
            type: 'villager',
            target: 'marta',
            stat: 'trust',
            delta: 20,
            reason: 'Marta is grateful for your discretion.'
          });
        }
        break;

      case 3: // Secret Meetings
        if (fragIds.includes('w3_concerning_behavior') || fragIds.includes('w3_unbecoming')) {
          effects.push({
            type: 'story',
            flag: 'luciaExposed',
            value: true,
            reason: 'You exposed Lucia\'s relationship.'
          });
          effects.push({
            type: 'villager',
            target: 'lucia',
            stat: 'wellbeing',
            delta: -30,
            reason: 'Lucia\'s hopes are crushed.'
          });
          effects.push({
            type: 'villager',
            target: 'lucia',
            stat: 'trust',
            delta: -50,
            reason: 'Lucia will never trust you again.'
          });
          effects.push({
            type: 'villager',
            target: 'jakub',
            stat: 'wellbeing',
            delta: -20,
            reason: 'Jakub is pressured by his family.'
          });
        }

        if (fragIds.includes('w3_no_concern') || fragIds.includes('w3_potential_unity')) {
          effects.push({
            type: 'story',
            flag: 'luciaProtected',
            value: true,
            reason: 'You protected Lucia\'s secret.'
          });
          effects.push({
            type: 'villager',
            target: 'lucia',
            stat: 'trust',
            delta: 25,
            reason: 'Lucia trusts you completely.'
          });
          effects.push({
            type: 'villager',
            target: 'tomas',
            stat: 'trust',
            delta: 15,
            reason: 'Tomas is grateful you protected his daughter.'
          });
        }

        if (fragIds.includes('w3_connection_formed') || fragIds.includes('w3_newcomer_shore')) {
          effects.push({
            type: 'story',
            flag: 'luciaRomanceBlessed',
            value: true,
            reason: 'You officially blessed the relationship.'
          });
          effects.push({
            type: 'tension',
            delta: -5,
            reason: 'A bridge forms between families.'
          });
        }
        break;

      case 4: // Storm's Toll
        if (fragIds.includes('w4_destroyed_failure') || fragIds.includes('w4_negligence')) {
          effects.push({
            type: 'story',
            flag: 'blamedTomas',
            value: true,
            reason: 'You blamed Tomas for the boat\'s destruction.'
          });
          effects.push({
            type: 'villager',
            target: 'tomas',
            stat: 'wellbeing',
            delta: -30,
            reason: 'Tomas owes a debt he cannot pay.'
          });
          effects.push({
            type: 'villager',
            target: 'lucia',
            stat: 'wellbeing',
            delta: -20,
            reason: 'Lucia\'s father is ruined.'
          });
        }

        if (fragIds.includes('w4_deliberate_sabotage')) {
          effects.push({
            type: 'story',
            flag: 'sabotageAlleged',
            value: true,
            reason: 'You alleged criminal sabotage.'
          });
          effects.push({
            type: 'tension',
            delta: 25,
            reason: 'Criminal allegations tear the village apart.'
          });
        }

        if (fragIds.includes('w4_line_tampered')) {
          effects.push({
            type: 'story',
            flag: 'blamedPeter',
            value: true,
            reason: 'You implied Shore family sabotage.'
          });
          effects.push({
            type: 'villager',
            target: 'peter',
            stat: 'wellbeing',
            delta: -25,
            reason: 'Peter is devastated by the accusation.'
          });
          effects.push({
            type: 'faction',
            target: 'shore',
            delta: -15,
            reason: 'The Shore family\'s honor is questioned.'
          });
        }

        if (fragIds.includes('w4_evidence_inconclusive') || fragIds.includes('w4_storm_damage')) {
          effects.push({
            type: 'story',
            flag: 'blamedNoOne',
            value: true,
            reason: 'You blamed no one.'
          });
          effects.push({
            type: 'tension',
            delta: 5,
            reason: 'The wound remains open.'
          });
        }

        if (storyFlags.annaTestified && fragIds.includes('w4_witness_reported')) {
          effects.push({
            type: 'villager',
            target: 'anna',
            stat: 'wellbeing',
            delta: -10,
            reason: 'Anna\'s testimony puts her in a difficult position.'
          });
        }
        break;

      case 5: // Reckoning
        if (fragIds.includes('w5_served_faithfully')) {
          effects.push({
            type: 'story',
            flag: 'truthCount',
            delta: 1,
            reason: 'You judged yourself fairly.'
          });
        }
        break;
    }

    return effects;
  },

  // Track player archetype (honest, merciful, self-serving)
  trackArchetype(entry, storyFlags) {
    const effects = [];
    const fragIds = Object.values(entry).filter(Boolean).map(f => f.id);

    // Honest: hard truths, evidence-based, no hedging
    const honestFrags = ['w2_death_reexamine', 'w2_historical_inaccuracies', 'tone_certain', 'w4_deliberate_sabotage'];
    const honestCount = fragIds.filter(id => honestFrags.includes(id)).length;
    if (honestCount > 0) {
      effects.push({
        type: 'story',
        flag: 'truthCount',
        delta: honestCount,
        reason: 'You chose truth.'
      });
    }

    // Merciful: protection, hedging, omission
    const mercyFrags = ['w2_no_substance', 'w3_no_concern', 'w3_potential_unity', 'tone_hedged', 'w2_peace_over_truth'];
    const mercyCount = fragIds.filter(id => mercyFrags.includes(id)).length;
    if (mercyCount > 0) {
      effects.push({
        type: 'story',
        flag: 'mercyCount',
        delta: mercyCount,
        reason: 'You showed mercy.'
      });
    }

    // Self-serving: avoiding commitment, playing it safe
    const safeFrags = ['context_unclear', 'action_allegedly', 'w1_evidence_inconclusive'];
    const safeCount = fragIds.filter(id => safeFrags.includes(id)).length;
    if (safeCount > 1) { // Only counts as self-serving if consistent
      effects.push({
        type: 'story',
        flag: 'selfServingCount',
        delta: 1,
        reason: 'You protected yourself.'
      });
    }

    return effects;
  },

  // Apply effects to game state
  applyEffects(effects, stateManager) {
    effects.forEach(effect => {
      switch (effect.type) {
        case 'villager':
          stateManager.updateVillager(effect.target, effect.stat, effect.delta);
          break;
        case 'tension':
          stateManager.updateTension(effect.delta);
          break;
        case 'story':
          if (effect.delta !== undefined) {
            // Increment a counter
            const current = stateManager.getState().story[effect.flag] || 0;
            stateManager.setStoryFlag(effect.flag, current + effect.delta);
          } else {
            stateManager.setStoryFlag(effect.flag, effect.value);
          }
          break;
        case 'faction':
          // Track faction standings (could be expanded)
          console.log(`Faction ${effect.target}: ${effect.delta > 0 ? '+' : ''}${effect.delta}`);
          break;
      }
    });
  },

  // Get tension level description
  getTensionLevel(tension) {
    if (tension < 30) return 'low';
    if (tension < 50) return 'medium';
    if (tension < 80) return 'high';
    return 'critical';
  },

  // Check for ending triggers
  checkEndingConditions(storyFlags, villagerStats) {
    const conditions = {
      collapse: false,
      fracture: false,
      endurance: false,
      peace: false
    };

    if (storyFlags.tension >= 80) {
      conditions.collapse = true;
    } else if (storyFlags.tension >= 50) {
      conditions.fracture = true;
    } else if (storyFlags.tension >= 30) {
      conditions.endurance = true;
    } else {
      conditions.peace = true;
    }

    // Check for specific bad endings
    if (villagerStats.tomas && villagerStats.tomas.wellbeing < 20) {
      conditions.tomasLeaves = true;
    }
    if (villagerStats.lucia && villagerStats.lucia.trust < 10) {
      conditions.luciaBroken = true;
    }

    return conditions;
  },

  // Calculate final keeper archetype
  calculateKeeperArchetype(storyFlags) {
    const { truthCount, mercyCount, selfServingCount } = storyFlags;

    if (truthCount > mercyCount && truthCount > selfServingCount) {
      return 'honest';
    }
    if (mercyCount > truthCount && mercyCount > selfServingCount) {
      return 'merciful';
    }
    if (selfServingCount >= truthCount && selfServingCount >= mercyCount && selfServingCount > 0) {
      return 'corrupt';
    }
    return 'inconsistent';
  }
};

// Export
;
}


// === src/js/systems/memory.js ===
// Memory System for The Lighthouse Keeper

const MemoryContent = {
  firstRecord: {
    trigger: "As you examine the ambiguous evidence, something stirs in you.",
    text: `You remember another desk. Another set of facts that could have meant anything.

A man's name on a document. Evidence that pointed both ways. You had to decide. Someone had to decide.

You wrote him as guilty. The words came easily  too easily, perhaps. You told yourself the evidence was clear. You told yourself you were just doing your job.

Three months later, he was dead. Executed on your record.

You wonder, sometimes, if you were right. You'll never know. That's the weight you carry.`
  },

  theAccused: {
    trigger: "The priest speaks of confession. Of secrets carried too long.",
    text: `You wanted to confess, once. After.

You went to the chapel in the city  not your usual one, somewhere no one knew you. You sat in the booth and tried to find the words.

"I may have killed an innocent man."

But the words wouldn't come. What would absolution mean, if you couldn't undo what you'd done? What would forgiveness change?

You left without speaking. You've never been back.

That's when you started looking for somewhere far away. Somewhere records didn't matter. You found this lighthouse. You thought you could escape.

You were wrong.`
  },

  theWife: {
    trigger: "Lucia begs you, her eyes full of desperate hope.",
    text: `There was a woman. The accused man's wife.

She came to your office the day before the execution. She begged. She brought their children  a boy and a girl, younger than Lucia.

"Please," she said. "There must be something. Some doubt. Some mercy."

You told her the record was final. You told her the evidence was clear. You told yourself these things too, because if you didn't believe them, how could you live with what you'd done?

She looked at you the way Lucia is looking at you now.

You wonder, sometimes, what happened to her. To the children. You've never tried to find out.`
  },

  theEvidence: {
    trigger: "You examine the physical evidence, and it tells you nothing certain.",
    text: `The evidence in his case was like this. Ambiguous. Interpretable.

A witness who might have been mistaken. Documents that could have been forged. Testimony that contradicted itself in small ways  the ways real memory contradicts itself, or the ways lies do.

You could have written it either way. You chose guilt.

Why? You've asked yourself a thousand times. Because it was easier? Because someone above you wanted it? Because you genuinely believed?

You don't remember anymore. That's the worst part. You've told yourself so many stories about that day that the truth is lost somewhere underneath.

All that's left is the weight.`
  },

  theName: {
    trigger: "You prepare to write about yourself, and everything comes back.",
    text: `His name was Alejandro Veras.

You hadn't thought his name in years. You'd buried it under lighthouse duties and village records and careful distance.

But here, now, writing about yourself  about the Keeper, about who you've been  his name comes back.

Alejandro Veras. A clerk accused of embezzlement. A man with a family. A man whose fate crossed your desk on an ordinary Tuesday.

You made him guilty with your pen.

You made yourself a murderer. Or an instrument of justice. You still don't know which.

The record is never the event. But when the record is all anyone has...

What will you write about yourself, Keeper? What truth? What mercy? What silence?`
  }
};

const MemorySystem = {
  // Show memory overlay
  showMemory(memoryId, callback) {
    const memory = MemoryContent[memoryId];
    if (!memory) {
      if (callback) callback();
      return;
    }

    const overlay = document.getElementById('memory-overlay');
    const triggerEl = document.getElementById('memory-trigger');
    const textEl = document.getElementById('memory-text');
    const dismissBtn = document.getElementById('memory-dismiss');

    if (!overlay || !triggerEl || !textEl) {
      if (callback) callback();
      return;
    }

    // Set content
    triggerEl.textContent = memory.trigger;
    textEl.innerHTML = memory.text.split('\n\n').map(p => `<p>${p}</p>`).join('');

    // Show overlay
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden', 'false');

    // Play memory sound if audio engine exists
    if (typeof AudioEngine !== 'undefined' && AudioEngine.playMemoryTrigger) {
      AudioEngine.playMemoryTrigger();
    }

    // Handle dismiss
    const handleDismiss = () => {
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden', 'true');
      dismissBtn.removeEventListener('click', handleDismiss);
      if (callback) callback();
    };

    dismissBtn.addEventListener('click', handleDismiss);

    // Also allow ESC to dismiss
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        handleDismiss();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
  },

  // Check if an action should trigger a memory
  checkTrigger(actionId, week, storyFlags) {
    const triggers = {
      'examine_evidence_1': 'firstRecord',
      'visit_priest_2': 'theAccused',
      'talk_lucia_3': 'theWife',
      'hear_peter_4': 'theEvidence',
      'examine_rope_4': 'theEvidence',
      'write_about_self': 'theName'
    };

    return triggers[actionId] || null;
  },

  // Get memory content for display elsewhere
  getMemoryContent(memoryId) {
    return MemoryContent[memoryId] || null;
  },

  // Check if all memories have been unlocked
  allMemoriesUnlocked(memories) {
    return Object.values(memories).every(v => v === true);
  },

  // Get unlocked memory count
  getUnlockedCount(memories) {
    return Object.values(memories).filter(v => v === true).length;
  }
};

// Export
;
}


// === src/js/ui/render.js ===
// UI Rendering System for The Lighthouse Keeper

const Renderer = {
  // Initialize UI elements
  init() {
    this.cacheElements();
    this.bindEvents();
  },

  // Cache DOM elements for performance
  cacheElements() {
    this.elements = {
      weekNumber: document.getElementById('week-number'),
      phaseLabel: document.getElementById('phase-label'),
      phaseDisplay: document.querySelector('.phase-display'),
      timeRemaining: document.getElementById('time-remaining'),
      tensionFill: document.getElementById('tension-fill'),
      tensionVignette: document.getElementById('tension-vignette'),
      villagerList: document.getElementById('villager-list'),
      eventTitle: document.getElementById('event-title'),
      eventDescription: document.getElementById('event-description'),
      actionGrid: document.getElementById('action-grid'),
      testimonyContainer: document.getElementById('testimony-container'),
      logWeek: document.getElementById('log-week'),
      entryPreview: document.getElementById('entry-preview'),
      submitBtn: document.getElementById('btn-submit-entry'),
      fragmentList: document.getElementById('fragment-list'),
      slots: {
        tone: document.getElementById('slot-tone'),
        subject: document.getElementById('slot-subject'),
        action: document.getElementById('slot-action'),
        object: document.getElementById('slot-object'),
        context: document.getElementById('slot-context')
      }
    };
  },

  // Bind UI events
  bindEvents() {
    // Submit button
    if (this.elements.submitBtn) {
      this.elements.submitBtn.addEventListener('click', () => {
        if (typeof Game !== 'undefined') {
          Game.submitEntry();
        }
      });
    }
  },

  // Update header displays
  updateHeader(state) {
    if (this.elements.weekNumber) {
      this.elements.weekNumber.textContent = state.week;
    }

    if (this.elements.phaseLabel) {
      this.elements.phaseLabel.textContent = state.phase.charAt(0).toUpperCase() + state.phase.slice(1);
    }

    if (this.elements.phaseDisplay) {
      this.elements.phaseDisplay.setAttribute('data-phase', state.phase);
    }

    if (this.elements.timeRemaining) {
      this.elements.timeRemaining.textContent = state.timeRemaining;
    }

    if (this.elements.logWeek) {
      this.elements.logWeek.textContent = `Week ${state.week} Entry`;
    }
  },

  // Update tension meter
  updateTension(tension) {
    if (this.elements.tensionFill) {
      this.elements.tensionFill.style.width = `${tension}%`;

      // Update color based on level
      const level = ConsequenceEngine.getTensionLevel(tension);
      this.elements.tensionFill.parentElement.setAttribute('data-tension', level);
    }

    // Update vignette
    if (this.elements.tensionVignette) {
      const level = ConsequenceEngine.getTensionLevel(tension);
      this.elements.tensionVignette.className = `tension-${level}`;
    }
  },

  // Render villager list
  renderVillagers(villagers, involvedIds = [], completedActions) {
    if (!this.elements.villagerList) return;

    // Ensure completedActions is a Set
    const actions = completedActions instanceof Set ? completedActions : new Set();

    const villagerIds = ['marta', 'peter', 'anna', 'tomas', 'lucia', 'simao', 'bela', 'jakub', 'helena'];

    this.elements.villagerList.innerHTML = villagerIds.map(id => {
      const villager = Villagers[id];
      const stats = villagers[id];
      if (!villager || !stats) return '';

      const isInvolved = involvedIds.includes(id);
      const hasSpoken = actions.has(`talk_${id}_${GameState.week}`) ||
                        actions.has(`final_${id}`);

      const wellbeingPercent = stats.wellbeing;
      const trustPercent = stats.trust;

      return `
        <div class="villager-card family-${villager.family} ${isInvolved ? 'involved' : ''} ${hasSpoken ? 'spoken' : ''}"
             data-villager="${id}"
             tabindex="0"
             role="button"
             aria-label="${villager.name}, ${villager.role}">
          <div class="villager-portrait">${this.getVillagerEmoji(id)}</div>
          <div class="villager-info">
            <div class="villager-name">${villager.name}</div>
            <div class="villager-role">${villager.role}</div>
          </div>
          <div class="villager-stats">
            <div class="stat-bar" title="Wellbeing: ${wellbeingPercent}%">
              <div class="stat-fill wellbeing" style="width: ${wellbeingPercent}%"></div>
            </div>
            <div class="stat-bar" title="Trust: ${trustPercent}%">
              <div class="stat-fill trust" style="width: ${trustPercent}%"></div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Add click handlers
    this.elements.villagerList.querySelectorAll('.villager-card').forEach(card => {
      card.addEventListener('click', () => {
        const villagerId = card.dataset.villager;
        this.showVillagerDetail(villagerId);
      });
    });
  },

  // Get emoji representation for villager
  getVillagerEmoji(villagerId) {
    const emojis = {
      marta: '&#128100;',   // bust silhouette (elder)
      peter: '&#9875;',    // anchor (fisherman)
      anna: '&#128138;',   // medical symbol
      tomas: '&#128736;',  // hammer (craftsman)
      lucia: '&#127800;',  // flower
      simao: '&#9764;',    // church/cross
      bela: '&#128016;',   // goat
      jakub: '&#127754;',  // wave
      helena: '&#127863;', // wine glass
      oldSimao: '&#128104;&#8205;&#129459;' // old man
    };
    return emojis[villagerId] || '&#128100;';
  },

  // Show villager detail modal
  showVillagerDetail(villagerId) {
    const villager = Villagers[villagerId];
    const stats = GameState.villagers[villagerId];
    if (!villager || !stats) return;

    if (typeof Modals !== 'undefined') {
      Modals.showVillagerDetail(villager, stats);
    }
  },

  // Render event and investigation options
  renderEvent(event, timeRemaining, completedActions) {
    if (!event) return;

    if (this.elements.eventTitle) {
      this.elements.eventTitle.textContent = event.title;
    }

    if (this.elements.eventDescription) {
      this.elements.eventDescription.innerHTML = event.description.split('\n\n').map(p => `<p>${p}</p>`).join('');
    }

    this.renderActions(event.actions, timeRemaining, completedActions);
  },

  // Render investigation action cards
  renderActions(actions, timeRemaining, completedActions) {
    if (!this.elements.actionGrid) return;
    if (!actions || !Array.isArray(actions)) return;

    // Ensure completedActions is a Set
    const completed = completedActions instanceof Set ? completedActions : new Set();

    this.elements.actionGrid.innerHTML = actions.map(action => {
      const isCompleted = completed.has(action.id);
      const canAfford = action.cost <= timeRemaining;
      const isDisabled = isCompleted || !canAfford;

      return `
        <div class="action-card ${isCompleted ? 'completed' : ''} ${isDisabled && !isCompleted ? 'disabled' : ''}"
             data-action="${action.id}"
             data-cost="${action.cost}"
             tabindex="${isDisabled ? '-1' : '0'}"
             role="button"
             aria-disabled="${isDisabled}">
          <div class="action-title">${action.title}</div>
          <div class="action-cost">${action.cost} hour${action.cost > 1 ? 's' : ''}</div>
          <div class="action-description">${action.description}</div>
        </div>
      `;
    }).join('');

    // Add click handlers
    this.elements.actionGrid.querySelectorAll('.action-card:not(.disabled):not(.completed)').forEach(card => {
      card.addEventListener('click', () => {
        const actionId = card.dataset.action;
        if (typeof Game !== 'undefined') {
          Game.performAction(actionId);
        }
      });
    });
  },

  // Show testimony after investigation
  showTestimony(testimony, villager) {
    if (!this.elements.testimonyContainer || !testimony) return;

    this.elements.testimonyContainer.style.display = 'block';
    this.elements.testimonyContainer.innerHTML = `
      <div class="testimony-speaker">
        <div class="testimony-portrait">${villager ? this.getVillagerEmoji(villager.id) : ''}</div>
        <div class="testimony-name">${villager ? villager.name : 'Your observation'}</div>
      </div>
      <blockquote class="testimony-text">${testimony.text}</blockquote>
      <p class="testimony-observation">${testimony.observation}</p>
      ${testimony.fragments ? `
        <div class="fragments-gained">
          <div class="fragments-gained-title">Fragments gathered:</div>
          ${testimony.fragments.map(fragId => {
            const frag = this.getFragmentById(fragId);
            return frag ? `<span class="fragment-preview">"${frag.text}"</span>` : '';
          }).join('')}
        </div>
      ` : ''}
    `;

    // Scroll to testimony
    this.elements.testimonyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  },

  // Hide testimony
  hideTestimony() {
    if (this.elements.testimonyContainer) {
      this.elements.testimonyContainer.style.display = 'none';
    }
  },

  // Get fragment by ID from all sources
  getFragmentById(fragId) {
    // Check base fragments
    if (BaseFragments[fragId]) return BaseFragments[fragId];

    // Check week fragments
    for (const weekKey in WeekFragments) {
      if (WeekFragments[weekKey][fragId]) {
        return WeekFragments[weekKey][fragId];
      }
    }
    return null;
  },

  // Render fragment tray
  renderFragments(fragments, usedFragments) {
    if (!this.elements.fragmentList) return;
    if (!fragments || !Array.isArray(fragments)) return;

    // Ensure usedFragments is a Set
    const used = usedFragments instanceof Set ? usedFragments : new Set();

    // Group fragments by type
    const grouped = {
      tone: [],
      subject: [],
      action: [],
      object: [],
      context: []
    };

    fragments.forEach(frag => {
      if (grouped[frag.type]) {
        grouped[frag.type].push(frag);
      }
    });

    // Render all fragments
    let html = '';
    Object.keys(grouped).forEach(type => {
      grouped[type].forEach(frag => {
        const isUsed = used.has(frag.id);
        html += `
          <div class="fragment ${isUsed ? 'used' : ''}"
               data-fragment-id="${frag.id}"
               data-type="${frag.type}"
               draggable="${!isUsed}"
               tabindex="0"
               title="${frag.description || ''}"
               aria-label="${frag.text}">
            "${frag.text}"
          </div>
        `;
      });
    });

    this.elements.fragmentList.innerHTML = html;

    // Initialize drag handlers
    if (typeof FragmentUI !== 'undefined') {
      FragmentUI.initDragHandlers();
    }
  },

  // Update entry slot
  updateSlot(slot, fragment) {
    const slotEl = this.elements.slots[slot];
    if (!slotEl) return;

    const slotContainer = slotEl.parentElement;

    if (fragment) {
      slotEl.textContent = `"${fragment.text}"`;
      slotContainer.classList.add('filled');
    } else {
      slotEl.textContent = '';
      slotContainer.classList.remove('filled');
    }

    this.updateEntryPreview();
  },

  // Update entry preview
  updateEntryPreview() {
    if (!this.elements.entryPreview) return;

    const entry = GameState.current.entry;
    const parts = [];

    if (entry.tone) parts.push(entry.tone.text);
    if (entry.subject) parts.push(entry.subject.text);
    if (entry.action) parts.push(entry.action.text);
    if (entry.object) parts.push(entry.object.text);
    if (entry.context) parts.push(entry.context.text);

    if (parts.length === 0) {
      this.elements.entryPreview.innerHTML = '<em>Compose your entry by dragging fragments into the slots above...</em>';
    } else {
      const text = parts.join(' ').trim();
      this.elements.entryPreview.textContent = text + (text.endsWith('.') ? '' : '.');
    }

    // Update submit button state
    this.updateSubmitButton();
  },

  // Update submit button state
  updateSubmitButton() {
    if (!this.elements.submitBtn) return;

    const entry = GameState.current.entry;
    const canSubmit = entry.subject !== null && entry.action !== null;

    this.elements.submitBtn.disabled = !canSubmit;
  },

  // Show consequence results
  showConsequences(entry, effects) {
    if (typeof Modals !== 'undefined') {
      Modals.showConsequences(entry, effects);
    }
  },

  // Show week transition
  showWeekTransition(week, callback) {
    const transition = document.getElementById('week-transition');
    const weekText = document.getElementById('transition-week');
    const phaseText = document.getElementById('transition-subtext');

    if (!transition || !weekText) {
      if (callback) callback();
      return;
    }

    const weekTitles = {
      1: 'The Disputed Catch',
      2: "The Priest's Fever",
      3: 'The Secret Meetings',
      4: "The Storm's Toll",
      5: 'The Reckoning'
    };

    weekText.textContent = `Week ${week}: ${weekTitles[week] || ''}`;
    if (phaseText) {
      phaseText.textContent = week === 5 ? 'Your final night' : 'A new dawn';
    }

    transition.classList.add('active');

    setTimeout(() => {
      transition.classList.remove('active');
      if (callback) callback();
    }, 3000);
  },

  // Enable rain effect
  enableRain() {
    const container = document.getElementById('rain-container');
    if (!container) return;

    // Clear existing
    container.innerHTML = '';

    // Create raindrops
    for (let i = 0; i < 100; i++) {
      const drop = document.createElement('div');
      drop.className = 'raindrop';
      drop.style.left = `${Math.random() * 100}%`;
      drop.style.animationDuration = `${0.3 + Math.random() * 0.4}s`;
      drop.style.animationDelay = `${Math.random() * 2}s`;
      drop.style.opacity = 0.3 + Math.random() * 0.4;
      container.appendChild(drop);
    }

    container.classList.add('active');
  },

  // Disable rain effect
  disableRain() {
    const container = document.getElementById('rain-container');
    if (container) {
      container.classList.remove('active');
    }
  },

  // Enable fog effect (Week 5)
  enableFog() {
    const fog = document.getElementById('fog-overlay');
    if (fog) {
      fog.classList.add('active');
    }
  },

  // Flash lighthouse beam
  flashBeam() {
    const beam = document.getElementById('lighthouse-beam');
    if (beam) {
      beam.classList.add('flare');
      setTimeout(() => beam.classList.remove('flare'), 500);
    }
  }
};

// Export
;
}


// === src/js/ui/fragments.js ===
// Fragment Drag-and-Drop System for The Lighthouse Keeper

const FragmentUI = {
  draggedFragment: null,
  draggedElement: null,

  // Initialize drag handlers on all fragments
  initDragHandlers() {
    const fragments = document.querySelectorAll('.fragment:not(.used)');
    const slots = document.querySelectorAll('.entry-slot');

    // Fragment drag start
    fragments.forEach(frag => {
      frag.addEventListener('dragstart', this.handleDragStart.bind(this));
      frag.addEventListener('dragend', this.handleDragEnd.bind(this));

      // Keyboard support
      frag.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          this.handleKeyboardSelect(frag);
        }
      });
    });

    // Slot drop handlers
    slots.forEach(slot => {
      slot.addEventListener('dragover', this.handleDragOver.bind(this));
      slot.addEventListener('dragleave', this.handleDragLeave.bind(this));
      slot.addEventListener('drop', this.handleDrop.bind(this));

      // Keyboard support
      slot.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          this.handleKeyboardPlace(slot);
        }
      });

      // Click to remove
      slot.addEventListener('click', (e) => {
        if (slot.classList.contains('filled')) {
          this.handleSlotClick(slot);
        }
      });
    });
  },

  // Handle drag start
  handleDragStart(e) {
    const fragId = e.target.dataset.fragmentId;
    this.draggedFragment = this.getFragmentById(fragId);
    this.draggedElement = e.target;

    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', fragId);

    // Play sound
    if (typeof AudioEngine !== 'undefined' && AudioEngine.playUISound) {
      AudioEngine.playUISound('pickup');
    }
  },

  // Handle drag end
  handleDragEnd(e) {
    e.target.classList.remove('dragging');
    this.draggedFragment = null;
    this.draggedElement = null;

    // Remove drag-over from all slots
    document.querySelectorAll('.entry-slot').forEach(slot => {
      slot.classList.remove('drag-over');
    });
  },

  // Handle drag over slot
  handleDragOver(e) {
    e.preventDefault();
    const slot = e.currentTarget;
    const acceptedType = slot.dataset.accepts;

    // Check if fragment type matches slot
    if (this.draggedFragment && this.draggedFragment.type === acceptedType) {
      e.dataTransfer.dropEffect = 'move';
      slot.classList.add('drag-over');
    } else {
      e.dataTransfer.dropEffect = 'none';
    }
  },

  // Handle drag leave slot
  handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
  },

  // Handle drop on slot
  handleDrop(e) {
    e.preventDefault();
    const slot = e.currentTarget;
    slot.classList.remove('drag-over');

    const fragId = e.dataTransfer.getData('text/plain');
    const fragment = this.getFragmentById(fragId);
    const slotType = slot.dataset.slot;

    if (fragment && fragment.type === slot.dataset.accepts) {
      // Place fragment in slot
      StateManager.placeFragment(slotType, fragment);

      // Update UI
      Renderer.updateSlot(slotType, fragment);
      this.markFragmentUsed(fragId, true);

      // Play sound
      if (typeof AudioEngine !== 'undefined' && AudioEngine.playUISound) {
        AudioEngine.playUISound('place');
      }

      // Check for memory trigger
      const memoryId = checkMemoryTrigger(fragId);
      if (memoryId && !GameState.memories[memoryId]) {
        StateManager.unlockMemory(memoryId);
        MemorySystem.showMemory(memoryId);
      }
    }
  },

  // Handle keyboard selection of fragment
  handleKeyboardSelect(fragEl) {
    const fragId = fragEl.dataset.fragmentId;
    const fragment = this.getFragmentById(fragId);

    if (!fragment) return;

    // Find matching slot
    const slots = document.querySelectorAll('.entry-slot');
    let targetSlot = null;

    slots.forEach(slot => {
      if (slot.dataset.accepts === fragment.type && !slot.classList.contains('filled')) {
        targetSlot = slot;
      }
    });

    if (targetSlot) {
      const slotType = targetSlot.dataset.slot;
      StateManager.placeFragment(slotType, fragment);
      Renderer.updateSlot(slotType, fragment);
      this.markFragmentUsed(fragId, true);

      // Play sound
      if (typeof AudioEngine !== 'undefined' && AudioEngine.playUISound) {
        AudioEngine.playUISound('place');
      }
    }
  },

  // Handle keyboard placement into slot
  handleKeyboardPlace(slot) {
    // If slot is filled, remove fragment
    if (slot.classList.contains('filled')) {
      this.handleSlotClick(slot);
    }
  },

  // Handle clicking a filled slot to remove fragment
  handleSlotClick(slot) {
    const slotType = slot.dataset.slot;
    const fragment = GameState.current.entry[slotType];

    if (fragment) {
      // Remove from state
      StateManager.removeFragment(slotType);

      // Update UI
      Renderer.updateSlot(slotType, null);
      this.markFragmentUsed(fragment.id, false);

      // Play sound
      if (typeof AudioEngine !== 'undefined' && AudioEngine.playUISound) {
        AudioEngine.playUISound('remove');
      }
    }
  },

  // Mark fragment as used/unused in the tray
  markFragmentUsed(fragId, isUsed) {
    const fragEl = document.querySelector(`.fragment[data-fragment-id="${fragId}"]`);
    if (fragEl) {
      if (isUsed) {
        fragEl.classList.add('used');
        fragEl.setAttribute('draggable', 'false');
      } else {
        fragEl.classList.remove('used');
        fragEl.setAttribute('draggable', 'true');
      }
    }
  },

  // Get fragment by ID
  getFragmentById(fragId) {
    // Check current available fragments
    const available = GameState.current.fragments;
    let found = available.find(f => f.id === fragId);
    if (found) return found;

    // Check base fragments
    if (BaseFragments[fragId]) return { ...BaseFragments[fragId] };

    // Check week fragments
    for (const weekKey in WeekFragments) {
      if (WeekFragments[weekKey][fragId]) {
        return { ...WeekFragments[weekKey][fragId] };
      }
    }

    return null;
  },

  // Clear all slots
  clearAllSlots() {
    const slotTypes = ['tone', 'subject', 'action', 'object', 'context'];
    slotTypes.forEach(slotType => {
      const fragment = GameState.current.entry[slotType];
      if (fragment) {
        StateManager.removeFragment(slotType);
        Renderer.updateSlot(slotType, null);
        this.markFragmentUsed(fragment.id, false);
      }
    });
  },

  // Add new fragment with animation
  addFragmentWithAnimation(fragment) {
    StateManager.addFragment(fragment);

    // Re-render fragments
    const fragments = getAvailableFragments(GameState.week, GameState.story);
    GameState.current.fragments.forEach(f => {
      if (!fragments.find(af => af.id === f.id)) {
        fragments.push(f);
      }
    });

    Renderer.renderFragments(fragments, GameState.current.usedFragments);

    // Find and animate the new fragment
    const newFragEl = document.querySelector(`.fragment[data-fragment-id="${fragment.id}"]`);
    if (newFragEl) {
      newFragEl.classList.add('fragment-new');
      setTimeout(() => newFragEl.classList.remove('fragment-new'), 300);
    }
  }
};

// Export
;
}


// === src/js/ui/modals.js ===
// Modal System for The Lighthouse Keeper

const Modals = {
  activeModal: null,

  // Show villager detail modal
  showVillagerDetail(villager, stats) {
    const content = `
      <div class="villager-detail">
        <div class="villager-detail-header">
          <div class="villager-detail-portrait">${Renderer.getVillagerEmoji(villager.id)}</div>
          <div class="villager-detail-info">
            <h3 class="villager-detail-name">${villager.name}</h3>
            <div class="villager-detail-meta">
              <span class="villager-age">Age ${villager.age}</span>
              <span class="villager-family family-${villager.family}">${villager.family}</span>
              <span class="villager-role-detail">${villager.role}</span>
            </div>
          </div>
        </div>

        <div class="villager-detail-stats">
          <div class="stat-row">
            <span class="stat-label">Wellbeing</span>
            <div class="stat-bar-large">
              <div class="stat-fill wellbeing" style="width: ${stats.wellbeing}%"></div>
            </div>
            <span class="stat-value">${stats.wellbeing}%</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Trust in You</span>
            <div class="stat-bar-large">
              <div class="stat-fill trust" style="width: ${stats.trust}%"></div>
            </div>
            <span class="stat-value">${stats.trust}%</span>
          </div>
        </div>

        <div class="villager-detail-description">
          <p>${villager.description.visible}</p>
        </div>

        <div class="villager-detail-dialogue">
          <p class="dialogue-quote">"${getDialogue(villager.id, stats.trust)}"</p>
        </div>
      </div>
    `;

    this.show('Villager', content);
  },

  // Show consequence modal after entry submission
  showConsequences(entryText, effects) {
    const consequenceModal = document.getElementById('consequence-modal');
    const entryEl = document.getElementById('consequence-entry');
    const effectsEl = document.getElementById('consequence-effects');
    const continueBtn = document.getElementById('consequence-continue');

    if (!consequenceModal || !entryEl || !effectsEl) return;

    // Show the entry text
    entryEl.innerHTML = `<blockquote class="entry-text entry-locked">"${entryText}"</blockquote>`;

    // Show effects
    effectsEl.innerHTML = effects.map((effect, i) => {
      let icon = '';
      let colorClass = '';

      if (effect.type === 'villager') {
        if (effect.delta > 0) {
          icon = '&#9650;'; // up arrow
          colorClass = 'effect-positive';
        } else {
          icon = '&#9660;'; // down arrow
          colorClass = 'effect-negative';
        }
        return `
          <div class="consequence-item ${colorClass}" style="animation-delay: ${i * 0.1}s">
            <span class="effect-icon">${icon}</span>
            <span class="effect-target">${effect.target}</span>
            <span class="effect-stat">${effect.stat}</span>
            <span class="effect-reason">${effect.reason}</span>
          </div>
        `;
      } else if (effect.type === 'tension') {
        if (effect.delta > 0) {
          icon = '&#9888;'; // warning
          colorClass = 'effect-warning';
        } else {
          icon = '&#9734;'; // star
          colorClass = 'effect-positive';
        }
        return `
          <div class="consequence-item ${colorClass}" style="animation-delay: ${i * 0.1}s">
            <span class="effect-icon">${icon}</span>
            <span class="effect-target">Village Tension</span>
            <span class="effect-delta">${effect.delta > 0 ? '+' : ''}${effect.delta}</span>
            <span class="effect-reason">${effect.reason}</span>
          </div>
        `;
      } else if (effect.type === 'story') {
        return `
          <div class="consequence-item effect-story" style="animation-delay: ${i * 0.1}s">
            <span class="effect-icon">&#128220;</span>
            <span class="effect-reason">${effect.reason}</span>
          </div>
        `;
      }
      return '';
    }).join('');

    // Show modal
    consequenceModal.style.display = 'flex';

    // Play entry lock sound
    if (typeof AudioEngine !== 'undefined' && AudioEngine.playEntryLock) {
      AudioEngine.playEntryLock();
    }

    // Flash the lighthouse beam
    Renderer.flashBeam();

    // Handle continue
    const handleContinue = () => {
      consequenceModal.style.display = 'none';
      continueBtn.removeEventListener('click', handleContinue);

      // Progress to next phase/week
      if (typeof Game !== 'undefined') {
        Game.progressAfterEntry();
      }
    };

    continueBtn.addEventListener('click', handleContinue);
  },

  // Show ending modal
  showEnding(ending, endingText) {
    const content = `
      <div class="ending-content">
        <h2 class="ending-title">The Record is Complete</h2>

        <div class="ending-summary">
          <div class="ending-badge village-${ending.village}">${ending.village.toUpperCase()}</div>
          <div class="ending-badge keeper-${ending.keeper}">The ${ending.keeper.charAt(0).toUpperCase() + ending.keeper.slice(1)} Keeper</div>
          <div class="ending-badge secret-${ending.secret}">The Truth ${ending.secret === 'revealed' ? 'Revealed' : 'Buried'}</div>
          <div class="ending-badge signature-${ending.signature}">${ending.signature === 'signed' ? 'Signed' : 'Anonymous'}</div>
        </div>

        <div class="ending-text">
          <p>${endingText}</p>
        </div>

        <div class="ending-footer">
          <p class="ending-quote">"The record is never the event. But when the record is all anyone has, the record becomes the truth."</p>
          <button class="modal-btn" onclick="Game.restart()">Begin Again</button>
        </div>
      </div>
    `;

    this.show('Ending', content, false); // No close button
  },

  // Show signature choice modal (Week 5)
  showSignatureChoice(callback) {
    const content = `
      <div class="signature-choice">
        <h3>The Final Entry</h3>
        <p class="signature-prompt">Your record is complete. Will you sign your name?</p>

        <div class="signature-options">
          <button class="signature-btn sign" data-choice="sign">
            <span class="signature-icon">&#9998;</span>
            <span class="signature-label">Sign Your Name</span>
            <span class="signature-desc">You take ownership. This is your record.</span>
          </button>

          <button class="signature-btn anonymous" data-choice="anonymous">
            <span class="signature-icon">&#128100;</span>
            <span class="signature-label">Leave Anonymous</span>
            <span class="signature-desc">The record exists, but you're not attached to it.</span>
          </button>
        </div>
      </div>
    `;

    this.show('The Final Choice', content, false);

    // Handle button clicks
    document.querySelectorAll('.signature-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const choice = btn.dataset.choice;
        this.close();
        callback(choice === 'sign');
      });
    });
  },

  // Generic show modal
  show(title, content, showClose = true) {
    // Create modal if doesn't exist
    let modal = document.getElementById('generic-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'generic-modal';
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title"></h3>
            <button class="modal-close" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body"></div>
        </div>
      `;
      document.body.appendChild(modal);

      // Add styles
      this.addModalStyles();
    }

    const titleEl = modal.querySelector('.modal-title');
    const bodyEl = modal.querySelector('.modal-body');
    const closeBtn = modal.querySelector('.modal-close');

    titleEl.textContent = title;
    bodyEl.innerHTML = content;
    closeBtn.style.display = showClose ? 'block' : 'none';

    modal.style.display = 'flex';
    modal.classList.add('modal-entering');

    setTimeout(() => {
      modal.classList.remove('modal-entering');
    }, 300);

    this.activeModal = modal;

    // Close handlers
    if (showClose) {
      closeBtn.onclick = () => this.close();
      modal.onclick = (e) => {
        if (e.target === modal) this.close();
      };
    }

    // ESC to close
    const handleEsc = (e) => {
      if (e.key === 'Escape' && showClose) {
        this.close();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
  },

  // Close active modal
  close() {
    if (this.activeModal) {
      this.activeModal.classList.add('modal-exiting');
      setTimeout(() => {
        this.activeModal.style.display = 'none';
        this.activeModal.classList.remove('modal-exiting');
        this.activeModal = null;
      }, 200);
    }
  },

  // Add modal styles dynamically
  addModalStyles() {
    if (document.getElementById('modal-styles')) return;

    const styles = document.createElement('style');
    styles.id = 'modal-styles';
    styles.textContent = `
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(10, 20, 25, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }

      .modal-content {
        background: var(--sea-mid);
        border: 1px solid rgba(240, 200, 96, 0.2);
        border-radius: var(--radius-lg);
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid rgba(240, 200, 96, 0.1);
      }

      .modal-title {
        margin: 0;
        font-size: 1.125rem;
        color: var(--land-light);
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--sea-foam);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      .modal-close:hover {
        color: var(--land-light);
      }

      .modal-body {
        padding: var(--space-lg);
      }

      .modal-btn {
        padding: var(--space-md) var(--space-lg);
        background: var(--land-dark);
        color: var(--land-light);
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-family: var(--font-system);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: var(--space-md);
      }

      .modal-btn:hover {
        background: var(--land-wood);
      }

      /* Villager detail styles */
      .villager-detail-header {
        display: flex;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
      }

      .villager-detail-portrait {
        font-size: 3rem;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--sea-surface);
        border-radius: 50%;
      }

      .villager-detail-name {
        margin: 0 0 var(--space-xs) 0;
      }

      .villager-detail-meta {
        display: flex;
        gap: var(--space-sm);
        flex-wrap: wrap;
        font-size: 0.8125rem;
        color: var(--sea-foam);
      }

      .villager-detail-stats {
        margin-bottom: var(--space-lg);
      }

      .stat-row {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-sm);
      }

      .stat-label {
        width: 100px;
        font-size: 0.8125rem;
        color: var(--sea-foam);
      }

      .stat-bar-large {
        flex: 1;
        height: 8px;
        background: var(--sea-surface);
        border-radius: 4px;
        overflow: hidden;
      }

      .stat-value {
        width: 40px;
        text-align: right;
        font-family: var(--font-system);
        font-size: 0.8125rem;
      }

      .dialogue-quote {
        font-style: italic;
        color: var(--light-dim);
        padding-left: var(--space-md);
        border-left: 2px solid var(--sea-foam);
      }

      /* Consequence styles */
      .consequence-content {
        max-width: 600px;
      }

      .consequence-entry {
        margin-bottom: var(--space-lg);
      }

      .entry-text {
        font-family: var(--font-log);
        font-size: 1.0625rem;
        line-height: 1.8;
        margin: 0;
        padding: var(--space-md);
        background: rgba(232, 220, 200, 0.1);
        border-radius: var(--radius-md);
      }

      .consequence-effects {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
      }

      .consequence-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-sm) var(--space-md);
        background: rgba(26, 45, 58, 0.3);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        opacity: 0;
        animation: consequence-appear 0.4s ease-out forwards;
      }

      .effect-icon {
        font-size: 1rem;
      }

      .effect-positive { border-left: 3px solid var(--light-verdant); }
      .effect-negative { border-left: 3px solid var(--light-danger); }
      .effect-warning { border-left: 3px solid var(--light-warning); }
      .effect-story { border-left: 3px solid var(--light-dim); }

      .effect-target {
        font-weight: 600;
        text-transform: capitalize;
      }

      .effect-reason {
        color: var(--sea-foam);
        margin-left: auto;
      }

      /* Signature choice styles */
      .signature-choice {
        text-align: center;
      }

      .signature-prompt {
        margin-bottom: var(--space-xl);
        font-size: 1.0625rem;
      }

      .signature-options {
        display: flex;
        gap: var(--space-md);
      }

      .signature-btn {
        flex: 1;
        padding: var(--space-lg);
        background: rgba(26, 45, 58, 0.3);
        border: 2px solid rgba(240, 200, 96, 0.2);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .signature-btn:hover {
        background: rgba(26, 45, 58, 0.5);
        border-color: var(--light-glow);
      }

      .signature-icon {
        display: block;
        font-size: 2rem;
        margin-bottom: var(--space-sm);
      }

      .signature-label {
        display: block;
        font-size: 1rem;
        color: var(--land-light);
        margin-bottom: var(--space-xs);
      }

      .signature-desc {
        display: block;
        font-size: 0.8125rem;
        color: var(--sea-foam);
      }

      /* Ending styles */
      .ending-content {
        text-align: center;
        padding: var(--space-lg);
      }

      .ending-title {
        font-size: 1.5rem;
        margin-bottom: var(--space-lg);
      }

      .ending-summary {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        justify-content: center;
        margin-bottom: var(--space-xl);
      }

      .ending-badge {
        padding: var(--space-xs) var(--space-md);
        background: var(--sea-surface);
        border-radius: var(--radius-md);
        font-family: var(--font-system);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .ending-text {
        font-size: 1.0625rem;
        line-height: 1.8;
        margin-bottom: var(--space-xl);
      }

      .ending-quote {
        font-style: italic;
        color: var(--sea-foam);
        margin-bottom: var(--space-lg);
      }

      /* Start screen styles */
      .start-content {
        text-align: center;
        max-width: 600px;
        padding: var(--space-2xl);
      }

      .start-title {
        font-size: 2.5rem;
        margin-bottom: var(--space-md);
        opacity: 0;
      }

      .start-subtitle {
        font-size: 1.125rem;
        color: var(--sea-foam);
        margin-bottom: var(--space-xl);
        opacity: 0;
      }

      .start-buttons {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        margin-bottom: var(--space-xl);
        opacity: 0;
      }

      .start-btn {
        padding: var(--space-md) var(--space-xl);
        border: 2px solid;
        border-radius: var(--radius-md);
        font-family: var(--font-system);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .start-btn.primary {
        background: var(--light-glow);
        border-color: var(--light-glow);
        color: var(--land-dark);
      }

      .start-btn.primary:hover {
        background: var(--light-dim);
        border-color: var(--light-dim);
      }

      .start-btn.secondary {
        background: transparent;
        border-color: var(--sea-foam);
        color: var(--land-light);
      }

      .start-btn.secondary:hover {
        border-color: var(--land-light);
      }

      .start-quote {
        font-style: italic;
        color: var(--sea-foam);
        line-height: 1.8;
        opacity: 0;
      }

      .icon-btn {
        background: transparent;
        border: 1px solid rgba(240, 200, 96, 0.2);
        color: var(--land-sand);
        padding: var(--space-sm);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 1rem;
      }

      .icon-btn:hover {
        border-color: var(--light-glow);
        color: var(--land-light);
      }
    `;
    document.head.appendChild(styles);
  }
};

// Export
;
}


// === src/js/audio/engine.js ===
// Audio Engine for The Lighthouse Keeper

const AudioEngine = {
  ctx: null,
  master: null,
  layers: {},
  initialized: false,
  enabled: false,

  // Initialize audio context (must be called from user interaction)
  init() {
    if (this.initialized) return;

    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.master = this.ctx.createGain();
      this.master.connect(this.ctx.destination);
      this.master.gain.value = 0.7;

      this.createSeaLayer();
      this.createWindLayer();
      this.createDroneLayer();
      this.createTensionLayer();

      this.initialized = true;
      this.enabled = true;

      // Update UI
      this.updateAudioIcon();

    } catch (e) {
      console.warn('Web Audio not supported:', e);
    }
  },

  // Create sea ambient layer (brown noise)
  createSeaLayer() {
    const bufferSize = 4096;
    const processor = this.ctx.createScriptProcessor(bufferSize, 1, 1);
    let lastOut = 0;

    processor.onaudioprocess = (e) => {
      const output = e.outputBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        output[i] = (lastOut + (0.02 * white)) / 1.02;
        lastOut = output[i];
        output[i] *= 3.5; // Boost signal
      }
    };

    const filter = this.ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 300;

    const gain = this.ctx.createGain();
    gain.gain.value = 0.12;

    // Slow volume modulation for wave rhythm
    const lfo = this.ctx.createOscillator();
    const lfoGain = this.ctx.createGain();
    lfo.frequency.value = 0.08;
    lfoGain.gain.value = 0.03;
    lfo.connect(lfoGain);
    lfoGain.connect(gain.gain);
    lfo.start();

    processor.connect(filter);
    filter.connect(gain);
    gain.connect(this.master);

    this.layers.sea = { processor, filter, gain, lfo };
  },

  // Create wind ambient layer
  createWindLayer() {
    const bufferSize = 4096;
    const processor = this.ctx.createScriptProcessor(bufferSize, 1, 1);

    processor.onaudioprocess = (e) => {
      const output = e.outputBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
    };

    const filter = this.ctx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 800;
    filter.Q.value = 0.5;

    const gain = this.ctx.createGain();
    gain.gain.value = 0.03;

    processor.connect(filter);
    filter.connect(gain);
    gain.connect(this.master);

    this.layers.wind = { processor, filter, gain };
  },

  // Create lighthouse drone layer
  createDroneLayer() {
    const osc1 = this.ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.value = 55; // Low A

    const osc2 = this.ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.value = 82.5; // E

    const gain = this.ctx.createGain();
    gain.gain.value = 0.03;

    // Slow pitch drift
    const lfo = this.ctx.createOscillator();
    const lfoGain = this.ctx.createGain();
    lfo.frequency.value = 0.05;
    lfoGain.gain.value = 1.5;
    lfo.connect(lfoGain);
    lfoGain.connect(osc1.frequency);

    osc1.connect(gain);
    osc2.connect(gain);
    gain.connect(this.master);

    osc1.start();
    osc2.start();
    lfo.start();

    this.layers.drone = { osc1, osc2, gain, lfo };
  },

  // Create tension layer (dissonant undertone)
  createTensionLayer() {
    const osc = this.ctx.createOscillator();
    osc.type = 'sawtooth';
    osc.frequency.value = 58; // Slightly detuned from drone

    const filter = this.ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 200;

    const gain = this.ctx.createGain();
    gain.gain.value = 0; // Starts silent

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(this.master);
    osc.start();

    this.layers.tension = { osc, filter, gain };
  },

  // Set tension level (0-100)
  setTension(level) {
    if (!this.initialized || !this.enabled) return;

    const normalizedTension = level / 100;

    // Fade in tension layer
    if (this.layers.tension) {
      this.layers.tension.gain.gain.setTargetAtTime(
        normalizedTension * 0.025,
        this.ctx.currentTime,
        1.0
      );
    }

    // Detune drone slightly
    if (this.layers.drone) {
      this.layers.drone.osc2.detune.setTargetAtTime(
        normalizedTension * 15,
        this.ctx.currentTime,
        1.0
      );
    }

    // Increase wind
    if (this.layers.wind) {
      this.layers.wind.gain.gain.setTargetAtTime(
        0.03 + normalizedTension * 0.05,
        this.ctx.currentTime,
        1.0
      );
    }
  },

  // Play entry lock sound
  playEntryLock() {
    if (!this.initialized || !this.enabled) return;

    const osc = this.ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(220, this.ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(55, this.ctx.currentTime + 0.5);

    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(0.25, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 1.0);

    // Add some texture
    const noise = this.ctx.createOscillator();
    noise.type = 'square';
    noise.frequency.value = 40;
    const noiseGain = this.ctx.createGain();
    noiseGain.gain.setValueAtTime(0.04, this.ctx.currentTime);
    noiseGain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);

    osc.connect(gain);
    noise.connect(noiseGain);
    gain.connect(this.master);
    noiseGain.connect(this.master);

    osc.start();
    noise.start();
    osc.stop(this.ctx.currentTime + 1.0);
    noise.stop(this.ctx.currentTime + 0.3);
  },

  // Play memory trigger sound
  playMemoryTrigger() {
    if (!this.initialized || !this.enabled) return;

    // Duck other audio briefly
    this.master.gain.setTargetAtTime(0.3, this.ctx.currentTime, 0.5);
    this.master.gain.setTargetAtTime(0.7, this.ctx.currentTime + 3, 1.0);

    // Ethereal tone
    const osc = this.ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = 330; // E4

    const filter = this.ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 600;

    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(0, this.ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.08, this.ctx.currentTime + 0.5);
    gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 3.0);

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(this.master);

    osc.start();
    osc.stop(this.ctx.currentTime + 3.0);

    // Second voice
    const osc2 = this.ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.value = 440; // A4

    const gain2 = this.ctx.createGain();
    gain2.gain.setValueAtTime(0, this.ctx.currentTime);
    gain2.gain.linearRampToValueAtTime(0.05, this.ctx.currentTime + 1);
    gain2.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 3.0);

    osc2.connect(filter);

    osc2.start();
    osc2.stop(this.ctx.currentTime + 3.0);
  },

  // Play UI sound
  playUISound(type) {
    if (!this.initialized || !this.enabled) return;

    const sounds = {
      pickup: { freq: 440, duration: 0.1, volume: 0.1 },
      place: { freq: 330, duration: 0.15, volume: 0.12 },
      remove: { freq: 220, duration: 0.1, volume: 0.08 },
      click: { freq: 880, duration: 0.05, volume: 0.06 }
    };

    const sound = sounds[type];
    if (!sound) return;

    const osc = this.ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = sound.freq;

    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(sound.volume, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + sound.duration);

    osc.connect(gain);
    gain.connect(this.master);

    osc.start();
    osc.stop(this.ctx.currentTime + sound.duration);
  },

  // Play week transition sound
  playWeekTransition() {
    if (!this.initialized || !this.enabled) return;

    // Musical sting
    const notes = [330, 392, 440]; // E, G, A
    notes.forEach((freq, i) => {
      const osc = this.ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = freq;

      const gain = this.ctx.createGain();
      const startTime = this.ctx.currentTime + i * 0.15;
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(0.1, startTime + 0.1);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + 1);

      osc.connect(gain);
      gain.connect(this.master);

      osc.start(startTime);
      osc.stop(startTime + 1);
    });
  },

  // Toggle audio on/off
  toggle() {
    if (!this.initialized) {
      this.init();
      return;
    }

    this.enabled = !this.enabled;

    if (this.enabled) {
      this.ctx.resume();
      this.master.gain.setTargetAtTime(0.7, this.ctx.currentTime, 0.5);
    } else {
      this.master.gain.setTargetAtTime(0, this.ctx.currentTime, 0.5);
    }

    this.updateAudioIcon();
  },

  // Update audio button icon
  updateAudioIcon() {
    const icon = document.getElementById('audio-icon');
    if (icon) {
      icon.innerHTML = this.enabled ? '&#128266;' : '&#128264;'; // speaker with/without sound
    }
  },

  // Suspend audio when tab is hidden
  handleVisibilityChange() {
    if (!this.initialized) return;

    if (document.hidden) {
      this.ctx.suspend();
    } else if (this.enabled) {
      this.ctx.resume();
    }
  },

  // Set storm intensity (Week 4)
  setStormIntensity(intensity) {
    if (!this.initialized || !this.enabled) return;

    // Increase wind dramatically
    if (this.layers.wind) {
      this.layers.wind.gain.gain.setTargetAtTime(
        0.1 + intensity * 0.15,
        this.ctx.currentTime,
        0.5
      );
      this.layers.wind.filter.frequency.setTargetAtTime(
        500 + intensity * 500,
        this.ctx.currentTime,
        0.5
      );
    }

    // Add low rumble
    if (intensity > 0.5) {
      this.layers.drone.gain.gain.setTargetAtTime(
        0.05 + intensity * 0.03,
        this.ctx.currentTime,
        0.5
      );
    }
  }
};

// Export
;
}


// === src/js/main.js ===
// Main Game Controller for The Lighthouse Keeper

const Game = {
  currentEvent: null,

  // Initialize the game
  init() {
    console.log('The Lighthouse Keeper - Initializing...');

    // Initialize renderer
    Renderer.init();

    // Add modal styles
    Modals.addModalStyles();

    // Setup event listeners
    this.setupEventListeners();

    // Check for save game
    if (StateManager.hasSave()) {
      document.getElementById('btn-continue').style.display = 'block';
    }

    // Show start screen
    document.getElementById('start-screen').style.display = 'flex';

    console.log('Initialization complete.');
  },

  // Setup global event listeners
  setupEventListeners() {
    // New game button
    document.getElementById('btn-new-game').addEventListener('click', () => {
      this.startNewGame();
    });

    // Continue button
    document.getElementById('btn-continue').addEventListener('click', () => {
      this.continueGame();
    });

    // Audio toggle
    document.getElementById('btn-audio').addEventListener('click', () => {
      AudioEngine.toggle();
    });

    // Handle visibility change for audio
    document.addEventListener('visibilitychange', () => {
      AudioEngine.handleVisibilityChange();
    });

    // State change listeners
    StateManager.on('tensionUpdate', (tension) => {
      Renderer.updateTension(tension);
      AudioEngine.setTension(tension);
    });

    StateManager.on('villagerUpdate', () => {
      this.refreshVillagers();
    });

    StateManager.on('fragmentAdded', (fragment) => {
      FragmentUI.addFragmentWithAnimation(fragment);
    });

    StateManager.on('weekChange', (week) => {
      this.onWeekChange(week);
    });

    StateManager.on('gameEnd', () => {
      this.onGameEnd();
    });
  },

  // Start a new game
  startNewGame() {
    // Clear any existing save
    StateManager.clearSave();

    // Reset state
    StateManager.reset();

    // Hide start screen, show game
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-container').style.display = 'grid';

    // Initialize audio on first user interaction
    AudioEngine.init();

    // Start Week 1
    this.startWeek(1);
  },

  // Continue saved game
  continueGame() {
    if (StateManager.load()) {
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('game-container').style.display = 'grid';

      AudioEngine.init();

      // Restore game state
      const state = StateManager.getState();
      this.startWeek(state.week, false); // Don't show transition
    }
  },

  // Start a specific week
  startWeek(week, showTransition = true) {
    const state = StateManager.getState();

    // Get event for this week
    this.currentEvent = StorySystem.getCurrentEvent(week, state.story, state.villagers);

    if (showTransition && week > 1) {
      Renderer.showWeekTransition(week, () => {
        this.renderWeek();
      });
      AudioEngine.playWeekTransition();
    } else {
      this.renderWeek();
    }

    // Week-specific effects
    if (week === 4) {
      Renderer.enableRain();
      AudioEngine.setStormIntensity(0.7);
    } else {
      Renderer.disableRain();
    }

    if (week === 5) {
      Renderer.enableFog();
    }

    // Save state
    StateManager.save();
  },

  // Render current week's content
  renderWeek() {
    const state = StateManager.getState();

    // Update header
    Renderer.updateHeader(state);

    // Update tension
    Renderer.updateTension(state.story.tension);

    // Render villagers
    const involvedIds = this.currentEvent ? this.currentEvent.involvedVillagers : [];
    Renderer.renderVillagers(state.villagers, involvedIds, state.current.completedActions);

    // Render event
    Renderer.renderEvent(this.currentEvent, state.timeRemaining, state.current.completedActions);

    // Hide testimony
    Renderer.hideTestimony();

    // Load available fragments
    const fragments = getAvailableFragments(state.week, state.story);
    state.current.fragments = fragments;
    Renderer.renderFragments(fragments, state.current.usedFragments);

    // Update entry preview
    Renderer.updateEntryPreview();
  },

  // Refresh villager display
  refreshVillagers() {
    const state = StateManager.getState();
    const involvedIds = this.currentEvent ? this.currentEvent.involvedVillagers : [];
    Renderer.renderVillagers(state.villagers, involvedIds, state.current.completedActions);
  },

  // Perform an investigation action
  performAction(actionId) {
    const state = StateManager.getState();
    const action = getAction(state.week, actionId);

    if (!action) return;
    if (action.cost > state.timeRemaining) return;
    if (state.current.completedActions.has(actionId)) return;

    // Use time
    StateManager.useTime(action.cost);

    // Mark action complete
    StateManager.completeAction(actionId);

    // Set story flag
    if (action.flag) {
      StateManager.setStoryFlag(action.flag, true);
    }

    // Check for memory trigger
    const memoryId = MemorySystem.checkTrigger(actionId, state.week, state.story);
    if (memoryId && !state.memories[memoryId]) {
      StateManager.unlockMemory(memoryId);
    }

    // Get testimony
    let testimony = action.testimony;

    // For Week 5, generate dynamic testimony
    if (state.week === 5 && action.requiresState) {
      testimony = StorySystem.getCurrentEvent(5, state.story, state.villagers)
        .actions.find(a => a.id === actionId)?.testimony;
    }

    // Get villager if applicable
    const villager = action.villager ? Villagers[action.villager] : null;

    // Show testimony
    if (testimony) {
      Renderer.showTestimony(testimony, villager);

      // Add fragments from testimony
      if (testimony.fragments) {
        testimony.fragments.forEach(fragId => {
          const frag = Renderer.getFragmentById(fragId);
          if (frag) {
            StateManager.addFragment({ ...frag });
          }
        });

        // Re-render fragments
        const newState = StateManager.getState();
        Renderer.renderFragments(newState.current.fragments, newState.current.usedFragments);
      }

      // Show memory if triggered
      if (memoryId && !state.memories[memoryId]) {
        setTimeout(() => {
          MemorySystem.showMemory(memoryId);
        }, 1500);
      }
    }

    // Update UI
    const newState = StateManager.getState();
    Renderer.updateHeader(newState);
    Renderer.renderActions(
      this.currentEvent.actions,
      newState.timeRemaining,
      newState.current.completedActions
    );
    this.refreshVillagers();

    // Play sound
    AudioEngine.playUISound('click');

    // Save
    StateManager.save();
  },

  // Submit the current entry
  submitEntry() {
    const state = StateManager.getState();
    const entry = state.current.entry;

    // Check if entry is complete
    if (!entry.subject || !entry.action) {
      return;
    }

    // Compose entry text
    const entryText = StateManager.composeEntryText();

    // Calculate consequences
    const effects = ConsequenceEngine.calculateConsequences(entry, state.week, state.story);

    // Apply effects
    ConsequenceEngine.applyEffects(effects, StateManager);

    // Submit entry to log
    StateManager.submitEntry();

    // Show consequences
    Renderer.showConsequences(entryText, effects);

    // Save
    StateManager.save();
  },

  // Progress after entry submission
  progressAfterEntry() {
    const state = StateManager.getState();

    // Week 5 special handling - signature choice
    if (state.week === 5) {
      Modals.showSignatureChoice((signed) => {
        StateManager.setStoryFlag('signedLog', signed);
        StateManager.save();

        // Show Bela's dialogue
        this.showBelaFinal(() => {
          // Then show ending
          this.showEnding();
        });
      });
      return;
    }

    // Advance to next week
    StateManager.advanceWeek();
  },

  // Handle week change
  onWeekChange(week) {
    this.startWeek(week);
  },

  // Show Bela's final dialogue
  showBelaFinal(callback) {
    const state = StateManager.getState();
    const belaDialogue = generateBelaDialogue(state.story);

    const content = `
      <div class="bela-final">
        <div class="bela-portrait" style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">
          ${Renderer.getVillagerEmoji('bela')}
        </div>
        <p class="bela-intro" style="text-align: center; color: var(--sea-foam); margin-bottom: 1rem;">
          After you submit your final entry, Bela comes to the lighthouse.
        </p>
        <blockquote style="font-style: italic; line-height: 1.8;">
          ${belaDialogue.text.split('\n\n').map(p => `<p>${p}</p>`).join('')}
        </blockquote>
        <p class="bela-observation" style="color: var(--sea-foam); margin-top: 1rem; font-size: 0.875rem;">
          ${belaDialogue.observation}
        </p>
        <button class="modal-btn" id="bela-continue" style="display: block; margin: 1.5rem auto 0;">Continue</button>
      </div>
    `;

    Modals.show("Bela's Visit", content, false);

    document.getElementById('bela-continue').addEventListener('click', () => {
      Modals.close();
      setTimeout(callback, 500);
    });
  },

  // Handle game end
  onGameEnd() {
    this.showEnding();
  },

  // Show ending
  showEnding() {
    const state = StateManager.getState();

    // Calculate ending
    const ending = StorySystem.calculateEnding(state.story, state.villagers);
    const endingText = StorySystem.generateEndingText(ending);

    // Show ending modal
    Modals.showEnding(ending, endingText);

    // Play ending music
    AudioEngine.playWeekTransition();
  },

  // Restart the game
  restart() {
    location.reload();
  }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  Game.init();
});

// Export for testing
;
}



  </script>
</body>
</html>